<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JuJutsu Kaisen D&D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/marked@4.2.12/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#5D5CDE',
                            dark: '#7A79E0',
                        },
                        jjk: {
                            blue: '#1E40AF',
                            purple: '#6B21A8',
                            red: '#991B1B',
                            dark: '#0F172A',
                            darker: '#030712',
                        },
                    },
                    fontFamily: {
                        display: ['Poppins', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-in forwards',
                        'typing': 'typing 1.5s steps(30, end) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        typing: {
                            '0%': { width: '0%' },
                            '100%': { width: '100%' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .dark-toggle-ball {
            transition: transform 0.3s ease;
        }

        .character-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .dice {
            transition: transform 0.3s ease-in-out;
        }

        .dice:hover {
            transform: rotate(15deg);
        }

        .typing-indicator::after {
            content: "...";
            animation: typingDots 1.5s infinite;
        }

        @keyframes typingDots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }

        .message-content p {
            margin-bottom: 0.75rem;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .message-content ul, .message-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .message-content ul {
            list-style-type: disc;
        }

        .message-content ol {
            list-style-type: decimal;
        }

        .pulse-border {
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% {
                border-color: rgba(93, 92, 222, 0.7);
            }
            50% {
                border-color: rgba(93, 92, 222, 1);
            }
        }
        
        /* Form field styles for better contrast */
        .form-input {
            color: #1a202c; /* Dark text on light inputs */
            background-color: white;
        }
        
        .dark .form-input {
            color: #e2e8f0; /* Light text on dark inputs */
            background-color: #2d3748;
        }
        
        /* Profile picture upload/preview */
        .profile-upload-label {
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        
        .profile-upload-label:hover .profile-upload-overlay {
            opacity: 1;
        }
        
        .profile-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 100%;
        }
        
        /* Shop item hover effect */
        .shop-item {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .shop-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Character sheet modal */
        .character-sheet-modal {
            transition: opacity 0.3s ease;
        }
        
        /* Game message typing animation */
        .typing-message {
            border-right: 2px solid;
            white-space: nowrap;
            overflow: hidden;
            animation: typing 3.5s steps(40, end), blink-caret .75s step-end infinite;
        }
        
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #5D5CDE; }
        }
        
        /* Resource bars shaking animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        /* Resource cost badges */
        .resource-cost {
            transition: all 0.2s ease;
        }
        
        .resource-cost:hover {
            transform: scale(1.1);
        }
        
        /* Technique cooldown overlay */
        .cooldown-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            transition: height 1s linear;
            pointer-events: none;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-center">
            <div class="flex items-center mb-4 sm:mb-0">
                <h1 class="text-3xl font-bold text-jjk-purple dark:text-primary-dark">JuJutsu Kaisen: A D&D Adventure!</h1>
                <div class="ml-3 text-sm relative">
                    <input type="checkbox" id="darkModeToggle" class="hidden">
                    <label for="darkModeToggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <div class="block w-12 h-6 rounded-full bg-gray-600 dark:bg-gray-400"></div>
                            <div class="dark-toggle-ball absolute left-1 top-1 bg-white w-4 h-4 rounded-full"></div>
                        </div>
                        <div class="ml-2 text-xs font-medium">
                            <span id="darkModeLabel">Dark Mode</span>
                        </div>
                    </label>
                </div>
            </div>
            <div id="userControls" class="flex gap-2">
                <button id="loginBtn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded transition">Login</button>
                <button id="signupBtn" class="bg-transparent border border-primary hover:bg-primary/10 text-primary dark:text-primary-dark font-bold py-2 px-4 rounded transition">Sign Up</button>
            </div>
            <div id="userInfo" class="hidden">
                <div class="flex items-center gap-2">
                    <span id="username" class="font-medium"></span>
                    <button id="logoutBtn" class="text-sm text-red-500 hover:text-red-700">Logout</button>
                </div>
            </div>
        </header>

        <!-- App Content -->
        <main class="relative">
            <!-- Start Screen -->
            <div id="startScreen" class="text-center py-12">
                <div class="bg-jjk-dark p-8 rounded-lg shadow-lg mb-8">
                    <h2 class="text-4xl font-bold mb-3 text-white">Enter the World of Jujutsu Sorcery</h2>
                    <p class="text-gray-200 text-lg max-w-2xl mx-auto">Become a sorcerer, battle curses, and navigate the dangerous world of Jujutsu Kaisen in this immersive adventure.</p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                    <div class="bg-white dark:bg-jjk-dark p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                        <h3 class="text-2xl font-semibold mb-3 text-jjk-blue dark:text-primary-dark">New Adventure</h3>
                        <p class="mb-4 text-gray-600 dark:text-gray-300">Create a new character and begin your journey as a Jujutsu Sorcerer.</p>
                        <button id="createCharacterBtn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg w-full transition">
                            Create Character
                        </button>
                    </div>
                    
                    <div class="bg-white dark:bg-jjk-dark p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                        <h3 class="text-2xl font-semibold mb-3 text-jjk-purple dark:text-primary-dark">Continue Journey</h3>
                        <p class="mb-4 text-gray-600 dark:text-gray-300">Load a saved character and continue your adventure.</p>
                        <button id="loadCharacterBtn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg w-full transition">
                            Load Character
                        </button>
                    </div>
                </div>

                <div class="mt-12 text-sm text-gray-500 dark:text-gray-400 max-w-2xl mx-auto">
                    <p>Create an account to save your progress and characters. You can save up to 3 characters and continue your adventure anytime.</p>
                </div>
                
                <div class="mt-6 p-4 bg-white dark:bg-jjk-dark rounded-lg shadow-md max-w-2xl mx-auto">
                    <h3 class="text-lg font-semibold mb-2 text-jjk-purple dark:text-primary-dark">Share This App</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">You can share this app with friends so they can join the adventure!</p>
                    <div class="flex justify-center">
                        <button id="copyLinkBtn" class="bg-primary/10 hover:bg-primary/20 text-primary dark:text-primary-dark font-medium py-2 px-4 rounded-md text-sm flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            Copy App Link
                        </button>
                    </div>
                </div>
            </div>

            <!-- Character Creation Screen -->
            <div id="characterCreationScreen" class="hidden">
                <div class="mb-6">
                    <button id="backToStartBtn" class="flex items-center text-primary dark:text-primary-dark hover:underline mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Back to Start
                    </button>
                    <h2 class="text-3xl font-bold mb-2">Create Your Character</h2>
                    <p class="text-gray-600 dark:text-gray-300">Design your Jujutsu Sorcerer to battle curses and navigate the world of JJK.</p>
                </div>

                <form id="characterForm" class="space-y-6 max-w-4xl">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="flex flex-col items-center mb-4">
                                <label for="profilePictureInput" class="profile-upload-label">
                                    <div id="profilePicturePreview" class="w-32 h-32 rounded-full mb-2 bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                        </svg>
                                    </div>
                                    <div class="profile-upload-overlay">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </div>
                                </label>
                                <input type="file" id="profilePictureInput" accept="image/*" class="hidden">
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Click to upload profile picture</p>
                            </div>
                            
                            <div>
                                <label for="charName" class="block text-sm font-medium mb-1">Character Name</label>
                                <input type="text" id="charName" name="charName" required
                                    class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                            </div>
                            
                            <div>
                                <label for="charGender" class="block text-sm font-medium mb-1">Gender</label>
                                <select id="charGender" name="charGender" required
                                    class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="charBackground" class="block text-sm font-medium mb-1">Background</label>
                                <select id="charBackground" name="charBackground" required
                                    class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                                    <option value="">Select Background</option>
                                    <option value="Tokyo Jujutsu High Student">Tokyo Jujutsu High Student</option>
                                    <option value="Kyoto Jujutsu High Student">Kyoto Jujutsu High Student</option>
                                    <option value="Self-Taught Sorcerer">Self-Taught Sorcerer</option>
                                    <option value="Former Curse">Former Curse</option>
                                    <option value="Clan Sorcerer">Clan Sorcerer</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Sorcerer Grade</label>
                                <div class="border border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 rounded-md p-3">
                                    <p class="text-sm"><span class="font-medium">Grade 4 (Beginner)</span> - All sorcerers begin at Grade 4</p>
                                    <input type="hidden" id="sorcererGrade" name="sorcererGrade" value="Grade 4">
                                    <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        Your grade will increase as you gain experience and complete missions. Progression: Grade 4 → Grade 3 → Grade 2 → Semi-Grade 1 → Grade 1 → Special Grade.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Character Type</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="flex p-3 border border-gray-300 dark:border-gray-700 rounded-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <input type="radio" name="characterType" value="Sorcerer" class="mr-2" checked required>
                                        <div>
                                            <span class="font-medium">Jujutsu Sorcerer</span>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Has access to cursed techniques</p>
                                        </div>
                                    </label>
                                    
                                    <label class="flex p-3 border border-gray-300 dark:border-gray-700 rounded-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <input type="radio" name="characterType" value="HeavenlyRestriction" class="mr-2" required>
                                        <div>
                                            <span class="font-medium">Heavenly Restriction</span>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">No technique but enhanced physical abilities</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="techniqueSection">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Cursed Technique Type</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="flex p-3 border border-gray-300 dark:border-gray-700 rounded-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800">
                                            <input type="radio" name="techniqueType" value="Innate" class="mr-2" checked>
                                            <div>
                                                <span class="font-medium">Innate Technique</span>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">Born with a unique cursed technique</p>
                                            </div>
                                        </label>
                                        
                                        <label class="flex p-3 border border-gray-300 dark:border-gray-700 rounded-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800">
                                            <input type="radio" name="techniqueType" value="Learned" class="mr-2">
                                            <div>
                                                <span class="font-medium">Learned Technique</span>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">Mastered through training</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <label for="techniqueSelect" class="block text-sm font-medium mb-1">Cursed Technique</label>
                                    <div class="flex flex-col space-y-2">
                                        <select id="techniqueSelect" name="techniqueSelect" 
                                            class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                                            <option value="">Choose a technique or roll for a random one</option>
                                            <optgroup label="Innate Techniques">
                                                <option value="Limitless">Limitless (Infinity)</option>
                                                <option value="Ten Shadows">Ten Shadows Technique</option>
                                                <option value="Six Eyes">Six Eyes</option>
                                                <option value="Boogie Woogie">Boogie Woogie</option>
                                                <option value="Straw Doll">Straw Doll Technique</option>
                                                <option value="Cursed Speech">Cursed Speech</option>
                                                <option value="Blood Manipulation">Blood Manipulation</option>
                                                <option value="Projection Sorcery">Projection Sorcery</option>
                                                <option value="Ratio Technique">Ratio Technique</option>
                                                <option value="Copying">Copying</option>
                                                <option value="Idle Transfiguration">Idle Transfiguration</option>
                                                <option value="Cursed Spirit Manipulation">Cursed Spirit Manipulation</option>
                                                <option value="Construction">Construction</option>
                                                <option value="Disaster Flames">Disaster Flames</option>
                                                <option value="Disaster Tides">Disaster Tides</option>
                                                <option value="Disaster Plants">Disaster Plants</option>
                                                <option value="Shrine">Shrine (Sukuna's Technique)</option>
                                                <option value="Ice Formation">Ice Formation</option>
                                                <option value="Decay">Decay</option>
                                                <option value="Ui Ui's Teleportation">Ui Ui's Teleportation</option>
                                                <option value="Comedian">Comedian</option>
                                            </optgroup>
                                            <option value="random">Roll Random Technique</option>
                                        </select>
                                        
                                        <div id="randomTechniqueContainer" class="hidden">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-sm font-medium">Roll for Random Technique</span>
                                                <button type="button" id="rollTechniqueBtn" class="bg-primary/10 hover:bg-primary/20 text-primary dark:text-primary-dark font-medium py-1 px-3 rounded-md text-sm flex items-center">
                                                    Roll
                                                </button>
                                            </div>
                                            <div id="randomTechniqueResult" class="p-3 bg-gray-50 dark:bg-gray-800 rounded-md mb-2 hidden">
                                                <h4 class="font-medium text-sm text-primary dark:text-primary-dark mb-1">Your Rolled Technique:</h4>
                                                <p id="randomTechniqueText" class="text-sm"></p>
                                            </div>
                                        </div>
                                        
                                        <div id="techniqueDescription" class="p-3 bg-gray-50 dark:bg-gray-800 rounded-md mb-2 hidden">
                                            <h4 class="font-medium text-sm text-primary dark:text-primary-dark mb-1">Technique Description:</h4>
                                            <p id="techniqueDescriptionText" class="text-sm"></p>
                                            <div id="techniqueCost" class="mt-2 text-xs text-blue-600 dark:text-blue-400 font-medium px-2 py-1 bg-blue-50 dark:bg-blue-900/20 rounded-md hidden">
                                                Cost: <span id="techniqueEnergyCost">0</span> Cursed Energy
                                            </div>
                                        </div>
                                        
                                        <input type="hidden" id="cursedTechnique" name="cursedTechnique" value="">
                                        <input type="hidden" id="cursedTechniqueCost" name="cursedTechniqueCost" value="0">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="heavenlyRestrictionSection" class="hidden">
                                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-md">
                                    <h4 class="font-medium text-jjk-purple dark:text-primary-dark mb-2">Heavenly Restriction Benefits</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">Without a cursed technique, you gain superhuman physical abilities (x30 normal human capacity).</p>
                                    <ul class="list-disc list-inside text-sm text-gray-600 dark:text-gray-300 space-y-1">
                                        <li class="font-bold text-jjk-red dark:text-red-400">+30 to Strength (superhuman power)</li>
                                        <li class="font-bold text-jjk-red dark:text-red-400">+30 to Dexterity (superhuman speed)</li>
                                        <li class="font-bold text-jjk-red dark:text-red-400">+30 to Constitution (superhuman durability)</li>
                                        <li>Rapid healing (recover from injuries 10x faster)</li>
                                        <li>Superhuman senses (detect cursed energy and threats)</li>
                                        <li>Near-immunity to many cursed techniques</li>
                                    </ul>
                                    <div class="mt-3 p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded border border-yellow-200 dark:border-yellow-800">
                                        <p class="text-xs text-yellow-800 dark:text-yellow-200 italic">Like Maki Zenin or Toji Fushiguro, you cannot see curses without special tools but can sense their presence and approximate location.</p>
                                    </div>
                                    <div class="mt-3 p-2 bg-orange-50 dark:bg-orange-900/30 rounded border border-orange-200 dark:border-orange-800">
                                        <p class="text-xs text-orange-800 dark:text-orange-200">While you don't use cursed energy, you'll need to manage <span class="font-bold">stamina</span> for physical actions. Even with superhuman abilities, intense exertion will tire you.</p>
                                    </div>
                                    <input type="hidden" id="heavenlyRestrictionTechnique" name="cursedTechnique" value="Heavenly Restriction: Born without cursed techniques or cursed energy, but possesses superhuman physical abilities at 30x normal human capacity, similar to Toji Fushiguro or Maki Zenin. Cannot see curses without special tools but has enhanced senses to detect their presence.">
                                </div>
                            </div>
                            
                            <div>
                                <label for="cursedToolSelect" class="block text-sm font-medium mb-1">Cursed Tool/Weapon</label>
                                <div class="flex flex-col space-y-2">
                                    <select id="cursedToolSelect" name="cursedToolSelect" 
                                        class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                                        <option value="">Choose a cursed tool or roll for one</option>
                                        <optgroup label="Common Cursed Tools">
                                            <option value="Playful Cloud">Playful Cloud (Staff) - 800 ¥</option>
                                            <option value="Black Rope">Black Rope - 600 ¥</option>
                                            <option value="Slaughter Demon">Slaughter Demon (Sword) - 1200 ¥</option>
                                            <option value="Demon Dweller">Demon Dweller (Sword) - 900 ¥</option>
                                            <option value="Crescent Moon">Crescent Moon (Bladed Weapon) - 750 ¥</option>
                                            <option value="Chain of a Thousand Miles">Chain of a Thousand Miles - 850 ¥</option>
                                            <option value="Split Soul Katana">Split Soul Katana - 1000 ¥</option>
                                            <option value="Inverted Spear of Heaven">Inverted Spear of Heaven - 2000 ¥</option>
                                            <option value="Cursed Dagger">Cursed Dagger - 500 ¥</option>
                                            <option value="Soul Cutting Blade">Soul Cutting Blade - 1100 ¥</option>
                                            <option value="Blood Manipulation Needles">Blood Manipulation Needles - 700 ¥</option>
                                            <option value="Cursed Gauntlets">Cursed Gauntlets - 750 ¥</option>
                                            <option value="Cursed Bo Staff">Cursed Bo Staff - 650 ¥</option>
                                            <option value="Cursed Shuriken">Cursed Shuriken - 550 ¥</option>
                                        </optgroup>
                                        <option value="random">Roll Random Tool</option>
                                        <option value="none">None (Save Money)</option>
                                    </select>
                                    
                                    <div id="randomToolContainer" class="hidden">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium">Roll for Random Tool</span>
                                            <button type="button" id="rollToolBtn" class="bg-primary/10 hover:bg-primary/20 text-primary dark:text-primary-dark font-medium py-1 px-3 rounded-md text-sm flex items-center">
                                                Roll
                                            </button>
                                        </div>
                                        <div id="randomToolResult" class="p-3 bg-gray-50 dark:bg-gray-800 rounded-md mb-2 hidden">
                                            <h4 class="font-medium text-sm text-primary dark:text-primary-dark mb-1">Your Rolled Cursed Tool:</h4>
                                            <p id="randomToolText" class="text-sm"></p>
                                        </div>
                                    </div>
                                    
                                    <div id="toolDescription" class="p-3 bg-gray-50 dark:bg-gray-800 rounded-md mb-2 hidden">
                                        <h4 class="font-medium text-sm text-primary dark:text-primary-dark mb-1">Tool Description:</h4>
                                        <p id="toolDescriptionText" class="text-sm"></p>
                                        <div id="toolBonuses" class="mt-2 text-xs text-green-600 dark:text-green-400 font-medium hidden"></div>
                                        <div id="toolPrice" class="mt-2 text-xs text-yellow-500 font-medium"></div>
                                    </div>
                                    
                                    <div id="toolPriceWarning" class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-md mb-2 hidden">
                                        <h4 class="font-medium text-sm text-yellow-700 dark:text-yellow-400 mb-1 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                            Price Warning
                                        </h4>
                                        <p class="text-sm text-yellow-700 dark:text-yellow-300">The cost of this tool will be deducted from your starting money of 500 ¥.</p>
                                    </div>
                                    
                                    <input type="hidden" id="cursedToolPrice" name="cursedToolPrice" value="0">
                                    <input type="hidden" id="cursedToolDescription" name="cursedToolDescription" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium mb-3">Attributes (Distribute 20 points)</h3>
                        <p id="pointsRemaining" class="text-sm mb-3">Points Remaining: <span>20</span></p>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="stat-block">
                                <label for="strengthStat" class="block text-sm font-medium mb-1">Strength</label>
                                <div class="flex items-center">
                                    <button type="button" class="stat-btn-decrease px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-l-md">-</button>
                                    <input type="number" id="strengthStat" name="strengthStat" value="5" min="1" max="10" readonly
                                        class="w-16 text-center py-1 border-t border-b border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white form-input">
                                    <button type="button" class="stat-btn-increase px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-r-md">+</button>
                                </div>
                            </div>
                            
                            <div class="stat-block">
                                <label for="dexterityStat" class="block text-sm font-medium mb-1">Dexterity</label>
                                <div class="flex items-center">
                                    <button type="button" class="stat-btn-decrease px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-l-md">-</button>
                                    <input type="number" id="dexterityStat" name="dexterityStat" value="5" min="1" max="10" readonly
                                        class="w-16 text-center py-1 border-t border-b border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white form-input">
                                    <button type="button" class="stat-btn-increase px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-r-md">+</button>
                                </div>
                            </div>
                            
                            <div class="stat-block">
                                <label for="constitutionStat" class="block text-sm font-medium mb-1">Constitution</label>
                                <div class="flex items-center">
                                    <button type="button" class="stat-btn-decrease px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-l-md">-</button>
                                    <input type="number" id="constitutionStat" name="constitutionStat" value="5" min="1" max="10" readonly
                                        class="w-16 text-center py-1 border-t border-b border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white form-input">
                                    <button type="button" class="stat-btn-increase px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-r-md">+</button>
                                </div>
                            </div>
                            
                            <div class="stat-block">
                                <label for="intelligenceStat" class="block text-sm font-medium mb-1">Intelligence</label>
                                <div class="flex items-center">
                                    <button type="button" class="stat-btn-decrease px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-l-md">-</button>
                                    <input type="number" id="intelligenceStat" name="intelligenceStat" value="5" min="1" max="10" readonly
                                        class="w-16 text-center py-1 border-t border-b border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white form-input">
                                    <button type="button" class="stat-btn-increase px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-r-md">+</button>
                                </div>
                            </div>
                            
                            <div class="stat-block">
                                <label for="wisdomStat" class="block text-sm font-medium mb-1">Wisdom</label>
                                <div class="flex items-center">
                                    <button type="button" class="stat-btn-decrease px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-l-md">-</button>
                                    <input type="number" id="wisdomStat" name="wisdomStat" value="5" min="1" max="10" readonly
                                        class="w-16 text-center py-1 border-t border-b border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white form-input">
                                    <button type="button" class="stat-btn-increase px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-r-md">+</button>
                                </div>
                            </div>
                            
                            <div class="stat-block">
                                <label for="charismaStat" class="block text-sm font-medium mb-1">Charisma</label>
                                <div class="flex items-center">
                                    <button type="button" class="stat-btn-decrease px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-l-md">-</button>
                                    <input type="number" id="charismaStat" name="charismaStat" value="5" min="1" max="10" readonly
                                        class="w-16 text-center py-1 border-t border-b border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white form-input">
                                    <button type="button" class="stat-btn-increase px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-r-md">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" id="createGameBtn" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-5 px-6 rounded-lg transition text-xl shadow-md">
                            Create & Show Overview
                        </button>
                    </div>
                </form>
            </div>

            <!-- Character Overview Screen -->
            <div id="characterOverviewScreen" class="hidden">
                <div class="mb-6">
                    <button id="backToCreationBtn" class="flex items-center text-primary dark:text-primary-dark hover:underline mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Back to Character Creation
                    </button>
                    <h2 class="text-3xl font-bold mb-2">Character Overview</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">Review your character before starting your adventure</p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Left Column: Character Summary -->
                    <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-md p-6">
                        <div class="flex flex-col items-center mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
                            <div id="overview-portrait" class="w-32 h-32 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <h3 id="overview-name" class="text-2xl font-bold text-jjk-purple dark:text-primary-dark"></h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span id="overview-background" class="text-sm text-gray-600 dark:text-gray-300"></span>
                                <span class="w-1.5 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"></span>
                                <span id="overview-gender" class="text-sm text-gray-600 dark:text-gray-300"></span>
                            </div>
                            <div class="mt-3 px-3 py-1 bg-jjk-purple/10 rounded-full">
                                <span id="overview-grade" class="text-xs font-medium text-jjk-purple dark:text-primary-dark">Grade 4 Sorcerer</span>
                            </div>
                        </div>
                        
                        <!-- Status Stats Section -->
                        <div class="mb-6">
                            <h4 class="text-sm font-bold mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-jjk-purple dark:text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                STATUS
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Health -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs font-medium">Health</span>
                                        <span id="overview-health" class="text-xs"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                                
                                <!-- Resource (Cursed Energy or Stamina) -->
                                <div id="overview-energy-container">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs font-medium" id="overview-resource-label">Cursed Energy</span>
                                        <span id="overview-energy" class="text-xs"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div id="overview-resource-bar" class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                                
                                <div id="overview-stamina-container" class="hidden">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs font-medium">Stamina</span>
                                        <span id="overview-stamina" class="text-xs"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-orange-500 h-2 rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Money -->
                            <div class="mt-4 flex justify-between items-center">
                                <span class="text-sm font-medium flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                                    </svg>
                                    Starting Money
                                </span>
                                <span id="overview-money" class="font-bold text-yellow-500">500 ¥</span>
                            </div>
                        </div>
                        
                        <!-- Attributes Section -->
                        <div>
                            <h4 class="text-sm font-bold mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-jjk-purple dark:text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                                ATTRIBUTES
                            </h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-sm font-bold text-jjk-purple dark:text-primary-dark" id="overview-str"></div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">STR</div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-sm font-bold text-jjk-purple dark:text-primary-dark" id="overview-dex"></div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">DEX</div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-sm font-bold text-jjk-purple dark:text-primary-dark" id="overview-con"></div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">CON</div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-sm font-bold text-jjk-purple dark:text-primary-dark" id="overview-int"></div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">INT</div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-sm font-bold text-jjk-purple dark:text-primary-dark" id="overview-wis"></div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">WIS</div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-sm font-bold text-jjk-purple dark:text-primary-dark" id="overview-cha"></div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">CHA</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Abilities & Equipment -->
                    <div class="space-y-6">
                        <!-- Cursed Techniques or Heavenly Restriction Section -->
                        <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-md p-6">
                            <h4 class="text-sm font-bold mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-jjk-purple dark:text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                <span id="overview-abilities-title">CURSED TECHNIQUES</span>
                            </h4>
                            
                            <!-- Technique/Restriction Info -->
                            <div class="mb-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center mb-2">
                                    <span class="text-xs px-2 py-0.5 bg-jjk-purple/10 rounded-full text-jjk-purple dark:text-primary-dark mr-2" id="overview-technique-type">Innate Technique</span>
                                    <h5 class="text-sm font-medium" id="overview-technique-label">Primary Technique</h5>
                                </div>
                                <p id="overview-technique" class="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-line"></p>
                                
                                <!-- Energy cost badge for techniques -->
                                <div id="overview-technique-cost" class="mt-2 hidden">
                                    <span class="inline-block text-xs px-2 py-1 bg-blue-50 dark:bg-blue-900/20 rounded text-blue-600 dark:text-blue-400">
                                        Cost: <span id="overview-cost-value">0</span> Cursed Energy
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Additional Info Message -->
                            <div class="text-sm text-gray-600 dark:text-gray-300" id="overview-abilities-info">
                                <p class="italic">As you progress, you'll be able to learn additional techniques. 
                                These will become available as you gain experience and complete special quests.</p>
                            </div>
                        </div>
                        
                        <!-- Equipment Section -->
                        <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-md p-6">
                            <h4 class="text-sm font-bold mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-jjk-purple dark:text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                                EQUIPMENT
                            </h4>
                            
                            <div class="mb-4">
                                <div class="flex items-center mb-2">
                                    <span class="text-xs px-2 py-0.5 bg-jjk-purple/10 rounded-full text-jjk-purple dark:text-primary-dark mr-2">Cursed Tool</span>
                                    <h5 class="text-sm font-medium" id="overview-tool-name"></h5>
                                </div>
                                <p id="overview-tool-desc" class="text-sm text-gray-600 dark:text-gray-300"></p>
                                <div class="mt-2 flex flex-wrap gap-2">
                                    <div id="overview-tool-bonuses" class="text-xs text-green-600 dark:text-green-400 font-medium hidden px-2 py-1 bg-green-50 dark:bg-green-900/20 rounded-md"></div>
                                    <div id="overview-tool-price" class="text-xs text-yellow-500 font-medium px-2 py-1 bg-yellow-50 dark:bg-yellow-900/20 rounded-md hidden"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4">
                            <button id="startAdventureBtn" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg transition">
                                Start Your Adventure
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="hidden">
                <div class="flex flex-col">
                    <!-- Top Navigation Bar -->
                    <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-md p-3 mb-4 flex justify-between items-center">
                        <div class="flex items-center">
                            <button id="toggleCharPanelBtn" class="text-primary dark:text-primary-dark mr-3 md:hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </button>
                            <h3 id="mini-char-name" class="text-lg font-bold text-jjk-purple dark:text-primary-dark"></h3>
                            <span id="mini-grade" class="ml-2 px-2 py-0.5 text-xs bg-jjk-purple/10 text-jjk-purple dark:text-primary-dark rounded-full">Grade 4</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center">
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 w-20">
                                    <div id="mini-health-bar" class="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                                <span id="mini-health" class="ml-1 text-xs">100</span>
                            </div>
                            
                            <!-- Cursed Energy or Stamina in mini bar (based on character type) -->
                            <div id="mini-energy-container" class="flex items-center">
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 w-20">
                                    <div id="mini-energy-bar" class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                                <span id="mini-energy" class="ml-1 text-xs">100</span>
                            </div>
                            
                            <div id="mini-stamina-container" class="hidden flex items-center">
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 w-20">
                                    <div id="mini-stamina-bar" class="bg-orange-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                                <span id="mini-stamina" class="ml-1 text-xs">100</span>
                            </div>
                            
                            <div class="flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                                </svg>
                                <span id="mini-money" class="text-xs font-bold text-yellow-500">500</span>
                            </div>
                            <div class="flex gap-1">
                                <button id="showCharSheetBtn" class="bg-primary/10 text-primary dark:text-primary-dark p-1 rounded-full" title="View Character Sheet">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </button>
                                <button id="openShopBtn" class="bg-yellow-500/10 text-yellow-500 p-1 rounded-full" title="Open Shop">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                                    </svg>
                                </button>
                                <button id="quickSaveBtn" class="bg-green-500/10 text-green-500 p-1 rounded-full" title="Quick Save">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Game Area with Sliding Panel -->
                    <div class="flex">
                        <!-- Character Panel (hidden on mobile by default) -->
                        <div id="charPanel" class="hidden md:block w-full md:w-72 lg:w-80 flex-shrink-0 transform transition-transform duration-300 ease-in-out">
                            <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-md p-4 sticky top-4">
                                <div class="mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                                    <div class="flex flex-col items-center mb-3">
                                        <div id="char-portrait" class="w-24 h-24 rounded-full mb-2 bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                            </svg>
                                        </div>
                                        <h3 id="char-name" class="text-xl font-bold text-jjk-purple dark:text-primary-dark text-center"></h3>
                                        <p id="char-background" class="text-sm text-gray-600 dark:text-gray-300 text-center"></p>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 gap-2 my-3">
                                        <!-- Health Bar -->
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-xs font-medium">Health</span>
                                                <span id="health-value" class="text-xs">100/100</span>
                                            </div>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                                <div id="health-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 100%"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Cursed Energy Bar (for sorcerers) -->
                                        <div id="energy-container">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-xs font-medium">Cursed Energy</span>
                                                <span id="energy-value" class="text-xs">100/100</span>
                                            </div>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                                <div id="energy-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 100%"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Stamina Bar (for heavenly restriction) -->
                                        <div id="stamina-container" class="hidden">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-xs font-medium">Stamina</span>
                                                <span id="stamina-value" class="text-xs">100/100</span>
                                            </div>
                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                                <div id="stamina-bar" class="bg-orange-500 h-2.5 rounded-full" style="width: 100%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Money -->
                                    <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                                        <div class="flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                                            </svg>
                                            <span class="text-xs font-medium">Money:</span>
                                        </div>
                                        <span id="char-money" class="text-xs font-mono font-semibold text-yellow-500">500 ¥</span>
                                    </div>
                                    
                                    <!-- Level and XP -->
                                    <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                                        <div class="flex items-center">
                                            <span class="text-xs font-medium mr-2">Grade:</span>
                                            <span id="sorcerer-grade" class="text-xs px-2 py-0.5 bg-jjk-purple/10 text-jjk-purple dark:text-primary-dark rounded-full">Grade 4</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="text-xs font-medium mr-2">Level:</span>
                                            <span id="char-level" class="text-xs font-mono">1</span>
                                        </div>
                                    </div>
                                    
                                    <!-- XP Bar -->
                                    <div class="mt-2">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs font-medium">Experience</span>
                                            <span id="xp-value" class="text-xs">0/1000</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                            <div id="xp-bar" class="bg-yellow-500 h-1.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Techniques Section -->
                                <div class="mb-4" id="techniques-section">
                                    <h4 class="text-sm font-semibold mb-2 flex justify-between items-center">
                                        <span id="abilities-title">Cursed Techniques</span>
                                    </h4>
                                    
                                    <!-- For Sorcerers: Technique List -->
                                    <div id="technique-list">
                                        <!-- Primary Technique -->
                                        <div class="mb-3 p-2 border border-gray-200 dark:border-gray-700 rounded-md">
                                            <div class="flex justify-between items-start">
                                                <h5 id="primary-technique-name" class="text-xs text-jjk-purple dark:text-primary-dark font-medium mb-1">Primary Technique</h5>
                                                <span id="technique-cost" class="text-xs text-blue-600 dark:text-blue-400 px-1.5 rounded-full bg-blue-50 dark:bg-blue-900/10">
                                                    <span id="primary-technique-cost">20</span> CE
                                                </span>
                                            </div>
                                            <p id="char-technique" class="text-xs text-gray-600 dark:text-gray-300"></p>
                                            <button id="use-technique-btn" class="mt-2 w-full bg-primary/10 hover:bg-primary/20 text-primary dark:text-primary-dark text-xs font-medium py-1 px-2 rounded">
                                                Use Technique
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- For Heavenly Restriction: Special Abilities -->
                                    <div id="physical-abilities" class="hidden">
                                        <div class="mb-3 p-2 border border-gray-200 dark:border-gray-700 rounded-md">
                                            <div class="flex justify-between items-start">
                                                <h5 class="text-xs text-orange-600 dark:text-orange-400 font-medium mb-1">Superhuman Strength</h5>
                                                <span class="text-xs text-orange-600 dark:text-orange-400 px-1.5 rounded-full bg-orange-50 dark:bg-orange-900/10">
                                                    15 STA
                                                </span>
                                            </div>
                                            <p class="text-xs text-gray-600 dark:text-gray-300">Unleash your superhuman strength to deal massive damage to enemies.</p>
                                            <button id="use-strength-btn" class="mt-2 w-full bg-orange-500/10 hover:bg-orange-500/20 text-orange-600 dark:text-orange-400 text-xs font-medium py-1 px-2 rounded">
                                                Use Strength
                                            </button>
                                        </div>
                                        
                                        <div class="mb-3 p-2 border border-gray-200 dark:border-gray-700 rounded-md">
                                            <div class="flex justify-between items-start">
                                                <h5 class="text-xs text-orange-600 dark:text-orange-400 font-medium mb-1">Enhanced Speed</h5>
                                                <span class="text-xs text-orange-600 dark:text-orange-400 px-1.5 rounded-full bg-orange-50 dark:bg-orange-900/10">
                                                    20 STA
                                                </span>
                                            </div>
                                            <p class="text-xs text-gray-600 dark:text-gray-300">Move with incredible speed to dodge attacks or rapidly reposition.</p>
                                            <button id="use-speed-btn" class="mt-2 w-full bg-orange-500/10 hover:bg-orange-500/20 text-orange-600 dark:text-orange-400 text-xs font-medium py-1 px-2 rounded">
                                                Use Speed
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold mb-2">Attributes</h4>
                                    <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-xs text-gray-600 dark:text-gray-400">STR:</span>
                                            <span id="char-str" class="text-xs font-medium"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-gray-600 dark:text-gray-400">DEX:</span>
                                            <span id="char-dex" class="text-xs font-medium"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-gray-600 dark:text-gray-400">CON:</span>
                                            <span id="char-con" class="text-xs font-medium"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-gray-600 dark:text-gray-400">INT:</span>
                                            <span id="char-int" class="text-xs font-medium"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-gray-600 dark:text-gray-400">WIS:</span>
                                            <span id="char-wis" class="text-xs font-medium"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-gray-600 dark:text-gray-400">CHA:</span>
                                            <span id="char-cha" class="text-xs font-medium"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold mb-2">Game Actions</h4>
                                    <div class="flex justify-center mb-3">
                                        <button id="rollDiceBtn" class="flex items-center justify-center bg-primary/10 hover:bg-primary/20 text-primary dark:text-primary-dark font-medium rounded-full w-12 h-12">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 dice" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                                <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                                                <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                                                <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <div id="diceResult" class="text-center text-sm hidden">
                                        <span class="font-bold text-jjk-purple dark:text-primary-dark text-xl"></span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400"></p>
                                    </div>
                                    
                                    <!-- Rest & Recovery Section -->
                                    <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                                        <button id="restBtn" class="w-full bg-green-500/10 hover:bg-green-500/20 text-green-600 dark:text-green-400 font-medium py-2 px-4 rounded mb-2 transition flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                            </svg>
                                            Rest & Recover
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="pt-3 border-t border-gray-200 dark:border-gray-700">
                                    <button id="saveGameBtn" class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-2 px-4 rounded mb-2 transition">
                                        Save Game
                                    </button>
                                    <button id="exitGameBtn" class="w-full bg-transparent border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium py-2 px-4 rounded transition">
                                        Exit Game
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Main Content Area (game narrative) -->
                        <div class="flex-1 ml-0 md:ml-4">
                            <!-- Narrative Section -->
                            <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-md p-4 mb-4">
                                <div class="relative overflow-hidden rounded-lg mb-4">
                                    <div id="currentSceneImg" class="w-full h-40 md:h-48 object-cover rounded-lg bg-gray-200 dark:bg-gray-700"></div>
                                </div>
                                
                                <div id="gameContent" class="mb-6 min-h-[300px] overflow-y-auto max-h-[60vh]">
                                    <div id="gameMessages" class="space-y-4">
                                        <!-- Game messages will appear here -->
                                    </div>
                                    <div id="loadingIndicator" class="hidden py-6 flex items-center justify-center">
                                        <div class="animate-pulse flex space-x-1">
                                            <div class="h-3 w-3 bg-primary dark:bg-primary-dark rounded-full"></div>
                                            <div class="h-3 w-3 bg-primary dark:bg-primary-dark rounded-full"></div>
                                            <div class="h-3 w-3 bg-primary dark:bg-primary-dark rounded-full"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Section (fixed at bottom) -->
                            <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-md p-4 sticky bottom-4">
                                <div id="gameControls">
                                    <div class="flex flex-col md:flex-row gap-3">
                                        <div class="flex-1">
                                            <label for="userAction" class="sr-only">Your Action</label>
                                            <textarea id="userAction" rows="2" placeholder="Describe your action or response..."
                                                class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input"></textarea>
                                        </div>
                                        <div class="flex items-start space-x-2">
                                            <button id="submitActionBtn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded transition">
                                                Submit
                                            </button>
                                            <div class="relative group">
                                                <button id="actionsMenuBtn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-bold py-3 px-3 rounded transition">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" />
                                                    </svg>
                                                </button>
                                                <div id="actionsDropdown" class="hidden absolute right-0 bottom-full mb-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-10 border border-gray-200 dark:border-gray-700">
                                                    <div class="py-1">
                                                        <button class="action-btn w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-action="attack">Attack</button>
                                                        <button class="action-btn w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-action="investigate">Investigate</button>
                                                        <button class="action-btn w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-action="use-technique">Use Cursed Technique</button>
                                                        <button class="action-btn w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-action="talk">Talk</button>
                                                        <button class="action-btn w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-action="use-item">Use Item</button>
                                                        <button class="action-btn w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-action="run">Run Away</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shop Screen -->
            <div id="shopScreen" class="hidden">
                <div class="mb-6">
                    <button id="backToGameBtn" class="flex items-center text-primary dark:text-primary-dark hover:underline mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Back to Game
                    </button>
                    <h2 class="text-3xl font-bold mb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                        Jujutsu Shop
                    </h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-3">Purchase cursed tools, techniques, and consumables</p>
                    <div class="flex items-center bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg border border-yellow-200 dark:border-yellow-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-medium">Your Money:</span>
                        <span id="shopMoney" class="ml-2 font-bold text-yellow-500">500 ¥</span>
                    </div>
                </div>
                
                <!-- Tabs for different shop categories -->
                <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
                    <nav class="flex flex-wrap -mb-px">
                        <button id="tabCursedTools" class="shop-tab-btn text-primary dark:text-primary-dark border-primary dark:border-primary-dark font-medium py-2 px-4 border-b-2">Cursed Tools</button>
                        <button id="tabConsumables" class="shop-tab-btn text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium py-2 px-4 border-b-2 border-transparent">Consumables</button>
                        <button id="tabTechniques" class="shop-tab-btn text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium py-2 px-4 border-b-2 border-transparent">Techniques</button>
                        <button id="tabInventory" class="shop-tab-btn text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium py-2 px-4 border-b-2 border-transparent">My Inventory</button>
                    </nav>
                </div>
                
                <!-- Cursed Tools Tab -->
                <div id="cursedToolsTab" class="shop-tab">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Playful Cloud</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">A heavy staff that increases in weight based on cursed energy input.</p>
                            <div class="text-xs text-green-600 dark:text-green-400 mb-3">+3 STR</div>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">800 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="playful_cloud" 
                                    data-item-name="Playful Cloud" 
                                    data-item-price="800" 
                                    data-item-type="tool"
                                    data-item-desc="A heavy staff that increases in weight and density based on the user's cursed energy input. Originally belonging to the Zenin clan, it can crush powerful curses with devastating force."
                                    data-item-bonuses='{"strength": 3}'>
                                    Buy
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Cursed Dagger</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">A small blade that can cut through cursed energy barriers.</p>
                            <div class="text-xs text-green-600 dark:text-green-400 mb-3">+2 DEX</div>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">500 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="cursed_dagger" 
                                    data-item-name="Cursed Dagger" 
                                    data-item-price="500" 
                                    data-item-type="tool"
                                    data-item-desc="A small blade that can cut through cursed energy barriers and disrupt the flow of cursed energy in targets. Its small size makes it easy to conceal and ideal for close-quarters combat."
                                    data-item-bonuses='{"dexterity": 2}'>
                                    Buy
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Inverted Spear of Heaven</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">A spear that can nullify any cursed technique it pierces.</p>
                            <div class="text-xs text-green-600 dark:text-green-400 mb-3">+3 INT, +2 WIS</div>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">2000 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="inverted_spear" 
                                    data-item-name="Inverted Spear of Heaven" 
                                    data-item-price="2000" 
                                    data-item-type="tool"
                                    data-item-desc="One of the most powerful cursed tools, this spear can nullify any cursed technique it pierces, including domain expansions. It completely neutralizes cursed energy upon contact."
                                    data-item-bonuses='{"intelligence": 3, "wisdom": 2}'>
                                    Buy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Consumables Tab -->
                <div id="consumablesTab" class="shop-tab hidden">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Healing Talisman</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">Single-use item that restores 50 health points when activated.</p>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">200 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="healing_talisman" 
                                    data-item-name="Healing Talisman" 
                                    data-item-price="200" 
                                    data-item-type="consumable"
                                    data-item-desc="Single-use item that restores 50 health points when activated."
                                    data-healing="50">
                                    Buy
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Energy Restoration Potion</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">Single-use item that restores 50 cursed energy points when consumed.</p>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">200 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="energy_potion" 
                                    data-item-name="Energy Restoration Potion" 
                                    data-item-price="200" 
                                    data-item-type="consumable"
                                    data-item-desc="Single-use item that restores 50 cursed energy points when consumed."
                                    data-energy="50">
                                    Buy
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Stamina Restoration Elixir</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">Single-use item that restores 50 stamina points for Heavenly Restriction users.</p>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">200 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="stamina_elixir" 
                                    data-item-name="Stamina Restoration Elixir" 
                                    data-item-price="200" 
                                    data-item-type="consumable"
                                    data-item-desc="Single-use item that restores 50 stamina points for Heavenly Restriction users."
                                    data-stamina="50">
                                    Buy
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Protection Charm</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">Reduces damage taken by 20% for one battle. Single-use.</p>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">350 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="protection_charm" 
                                    data-item-name="Protection Charm" 
                                    data-item-price="350" 
                                    data-item-type="consumable"
                                    data-item-desc="Reduces damage taken by 20% for one battle. Single-use.">
                                    Buy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Techniques Tab -->
                <div id="techniquesTab" class="shop-tab hidden">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Simple Domain</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">A defensive technique that creates a barrier nullifying domain expansions within its range.</p>
                            <div class="text-xs text-blue-600 dark:text-blue-400 mb-3">Cost: 30 Cursed Energy</div>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">1000 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="simple_domain" 
                                    data-item-name="Simple Domain" 
                                    data-item-price="1000" 
                                    data-item-type="technique"
                                    data-item-desc="A defensive technique that creates a barrier that nullifies all domain expansions within its range. It doesn't provide the overwhelming advantage of a domain expansion but offers protection against them."
                                    data-item-cost="30">
                                    Buy
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Black Flash</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Create an exponentially more powerful attack by perfectly timing cursed energy flow with a physical hit.</p>
                            <div class="text-xs text-blue-600 dark:text-blue-400 mb-3">Cost: 25 Cursed Energy</div>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">1200 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="black_flash" 
                                    data-item-name="Black Flash" 
                                    data-item-price="1200" 
                                    data-item-type="technique"
                                    data-item-desc="Not a standard technique but a phenomenon that occurs when a sorcerer perfectly times the flow of cursed energy with a physical hit. Creates an exponentially more powerful attack that deals 2.5x normal damage."
                                    data-item-cost="25">
                                    Buy
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-item bg-white dark:bg-jjk-dark p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold text-lg mb-1">Reverse Cursed Technique</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">The ability to reverse cursed energy flow to heal injuries rather than cause harm.</p>
                            <div class="text-xs text-blue-600 dark:text-blue-400 mb-3">Cost: 40 Cursed Energy</div>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-500">1500 ¥</span>
                                <button class="buy-item-btn bg-primary hover:bg-primary-dark text-white py-1 px-3 rounded text-sm" 
                                    data-item-id="reverse_cursed_technique" 
                                    data-item-name="Reverse Cursed Technique" 
                                    data-item-price="1500" 
                                    data-item-type="technique"
                                    data-item-desc="The ability to reverse cursed energy flow to heal injuries rather than cause harm. An advanced technique that few sorcerers master, it can heal even fatal wounds when applied correctly. Can be used on oneself or others."
                                    data-item-cost="40">
                                    Buy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Inventory Tab -->
                <div id="inventoryTab" class="shop-tab hidden">
                    <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-md p-5 mb-4">
                        <h3 class="text-xl font-semibold mb-4 text-jjk-purple dark:text-primary-dark">Your Inventory</h3>
                        <div id="shopInventoryItems" class="space-y-3">
                            <!-- Inventory items will be shown here -->
                            <p id="emptyShopInventoryMsg" class="text-gray-500 dark:text-gray-400">Your inventory is empty</p>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-md p-5">
                        <h3 class="text-xl font-semibold mb-4 text-jjk-blue dark:text-primary-dark">Equipped Items</h3>
                        <div id="shopEquippedItems" class="space-y-3">
                            <div class="p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-medium text-lg" id="shopEquippedToolName">No Item Equipped</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400" id="shopEquippedToolDescription">Equip an item from your inventory</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Character Sheet Modal (for quick view during gameplay) -->
            <div id="characterSheetModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 character-sheet-modal">
                <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-lg w-full max-w-2xl mx-4 p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-jjk-purple dark:text-primary-dark">Character Sheet</h2>
                        <button id="closeCharSheetBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <!-- Character Profile -->
                            <div class="flex items-center mb-4">
                                <div id="sheet-portrait" class="w-16 h-16 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 id="sheet-name" class="text-xl font-bold text-jjk-purple dark:text-primary-dark"></h3>
                                    <div class="flex items-center gap-2">
                                        <span id="sheet-background" class="text-sm text-gray-600 dark:text-gray-300"></span>
                                        <span class="w-1 h-1 bg-gray-300 dark:bg-gray-600 rounded-full"></span>
                                        <span id="sheet-grade" class="text-xs px-2 py-0.5 bg-jjk-purple/10 rounded-full text-jjk-purple dark:text-primary-dark">Grade 4</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Stats & Resources -->
                            <div class="mb-4 space-y-3">
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs font-medium">Health</span>
                                        <span id="sheet-health" class="text-xs">100/100</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div id="sheet-health-bar" class="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                                
                                <!-- Cursed Energy (for sorcerers) -->
                                <div id="sheet-energy-container">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs font-medium">Cursed Energy</span>
                                        <span id="sheet-energy" class="text-xs">100/100</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div id="sheet-energy-bar" class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                                
                                <!-- Stamina (for heavenly restriction) -->
                                <div id="sheet-stamina-container" class="hidden">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs font-medium">Stamina</span>
                                        <span id="sheet-stamina" class="text-xs">100/100</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div id="sheet-stamina-bar" class="bg-orange-500 h-2 rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs font-medium">Experience</span>
                                        <span id="sheet-xp" class="text-xs">0/1000</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                        <div id="sheet-xp-bar" class="bg-yellow-500 h-1.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Attributes -->
                            <div class="mb-4">
                                <h4 class="text-sm font-bold mb-2">Attributes</h4>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                                        <div id="sheet-str" class="text-sm font-bold text-jjk-purple dark:text-primary-dark">5</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">STR</div>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                                        <div id="sheet-dex" class="text-sm font-bold text-jjk-purple dark:text-primary-dark">5</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">DEX</div>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                                        <div id="sheet-con" class="text-sm font-bold text-jjk-purple dark:text-primary-dark">5</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">CON</div>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                                        <div id="sheet-int" class="text-sm font-bold text-jjk-purple dark:text-primary-dark">5</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">INT</div>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                                        <div id="sheet-wis" class="text-sm font-bold text-jjk-purple dark:text-primary-dark">5</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">WIS</div>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                                        <div id="sheet-cha" class="text-sm font-bold text-jjk-purple dark:text-primary-dark">5</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">CHA</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <!-- Cursed Technique or Heavenly Restriction -->
                            <div class="mb-4">
                                <h4 class="text-sm font-bold mb-2" id="sheet-abilities-title">Cursed Technique</h4>
                                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                                    <div class="flex items-center mb-1">
                                        <span id="sheet-technique-type" class="text-xs px-2 py-0.5 bg-jjk-purple/10 rounded-full text-jjk-purple dark:text-primary-dark mr-2">Innate Technique</span>
                                    </div>
                                    <p id="sheet-technique" class="text-sm text-gray-600 dark:text-gray-300"></p>
                                    
                                    <!-- Energy cost for technique (only for sorcerers) -->
                                    <div id="sheet-technique-cost" class="mt-2 hidden">
                                        <span class="inline-block text-xs px-2 py-1 bg-blue-50 dark:bg-blue-900/20 rounded text-blue-600 dark:text-blue-400">
                                            Cost: <span id="sheet-cost-value">0</span> Cursed Energy
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Equipped Tool -->
                            <div class="mb-4">
                                <h4 class="text-sm font-bold mb-2">Equipped Tool</h4>
                                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                                    <h5 id="sheet-tool-name" class="text-sm font-medium mb-1">None</h5>
                                    <p id="sheet-tool-desc" class="text-sm text-gray-600 dark:text-gray-300">No tool equipped</p>
                                </div>
                            </div>
                            
                            <!-- Money -->
                            <div class="flex items-center justify-between p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded">
                                <div class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                                    </svg>
                                    <span class="font-medium">Money:</span>
                                </div>
                                <span id="sheet-money" class="font-bold text-yellow-500">500 ¥</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resource Cost Confirmation Modal -->
            <div id="resourceConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-jjk-purple dark:text-primary-dark" id="resource-action-title">Use Technique</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mt-2" id="resource-action-desc">Are you sure you want to use this technique?</p>
                    </div>
                    
                    <div class="mb-6 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg" id="energy-cost-container">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                            </svg>
                            <span class="font-medium text-blue-700 dark:text-blue-300">Cursed Energy Cost:</span>
                            <span class="font-bold text-blue-700 dark:text-blue-300 ml-2" id="confirm-energy-cost">20</span>
                        </div>
                        <div class="text-sm text-blue-600 dark:text-blue-400 mt-2">
                            Your current energy: <span id="confirm-current-energy">100</span>/<span id="confirm-max-energy">100</span>
                        </div>
                    </div>
                    
                    <div class="mb-6 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg hidden" id="stamina-cost-container">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z" clip-rule="evenodd" />
                            </svg>
                            <span class="font-medium text-orange-700 dark:text-orange-300">Stamina Cost:</span>
                            <span class="font-bold text-orange-700 dark:text-orange-300 ml-2" id="confirm-stamina-cost">15</span>
                        </div>
                        <div class="text-sm text-orange-600 dark:text-orange-400 mt-2">
                            Your current stamina: <span id="confirm-current-stamina">100</span>/<span id="confirm-max-stamina">100</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button id="cancelResourceBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                            Cancel
                        </button>
                        <button id="confirmResourceBtn" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded transition">
                            Confirm
                        </button>
                    </div>
                </div>
            </div>

            <!-- Auth Modal -->
            <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
                <div class="bg-white dark:bg-jjk-dark rounded-lg shadow-lg w-full max-w-md mx-4 overflow-hidden">
                    <div class="flex">
                        <button id="loginTabBtn" class="flex-1 py-3 font-semibold transition">Login</button>
                        <button id="signupTabBtn" class="flex-1 py-3 font-semibold transition">Sign Up</button>
                    </div>
                    
                    <div id="loginForm" class="p-6">
                        <h3 class="text-xl font-bold mb-4 text-jjk-purple dark:text-primary-dark">Welcome Back</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="loginUsername" class="block text-sm font-medium mb-1">Username</label>
                                <input type="text" id="loginUsername" name="loginUsername" required
                                    class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                            </div>
                            <div>
                                <label for="loginPassword" class="block text-sm font-medium mb-1">Password</label>
                                <input type="password" id="loginPassword" name="loginPassword" required
                                    class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                            </div>
                            <button id="submitLoginBtn" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded transition">
                                Login
                            </button>
                        </div>
                    </div>
                    
                    <div id="signupForm" class="p-6 hidden">
                        <h3 class="text-xl font-bold mb-4 text-jjk-purple dark:text-primary-dark">Create Account</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="signupUsername" class="block text-sm font-medium mb-1">Username</label>
                                <input type="text" id="signupUsername" name="signupUsername" required
                                    class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                            </div>
                            <div>
                                <label for="signupPassword" class="block text-sm font-medium mb-1">Password</label>
                                <input type="password" id="signupPassword" name="signupPassword" required
                                    class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                            </div>
                            <div>
                                <label for="confirmPassword" class="block text-sm font-medium mb-1">Confirm Password</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" required
                                    class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-base form-input">
                            </div>
                            <button id="submitSignupBtn" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded transition">
                                Create Account
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                        <button id="closeAuthBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            Close
                        </button>
                    </div>
                </div>
            </div>

            <!-- Toast Notification -->
            <div id="toast" class="fixed bottom-20 right-4 bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4 w-64 transform translate-y-full opacity-0 transition-all duration-300 z-50 border border-gray-200 dark:border-gray-700">
                <div class="flex items-start">
                    <div id="toastIcon" class="flex-shrink-0 w-6 h-6 mr-3"></div>
                    <div class="flex-1">
                        <h3 id="toastTitle" class="font-medium text-gray-900 dark:text-white"></h3>
                        <p id="toastMessage" class="mt-1 text-sm text-gray-500 dark:text-gray-400"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Wait for the DOM to fully load before initializing the application
        document.addEventListener('DOMContentLoaded', () => {
            // Setup dark mode detection and toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            const darkModeLabel = document.getElementById('darkModeLabel');
            
            // Initialize dark mode based on system preference
            function initializeDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                    darkModeToggle.checked = true;
                    darkModeLabel.textContent = 'Light Mode';
                } else {
                    document.documentElement.classList.remove('dark');
                    darkModeToggle.checked = false;
                    darkModeLabel.textContent = 'Dark Mode';
                }
                
                applyDarkModeStyles();
            }
            
            // Apply dark mode specific styles
            function applyDarkModeStyles() {
                const isDarkMode = document.documentElement.classList.contains('dark');
                
                // Update background and text colors
                if (isDarkMode) {
                    document.body.classList.add('bg-jjk-darker', 'text-gray-100');
                    document.body.classList.remove('bg-gray-50', 'text-gray-900');
                } else {
                    document.body.classList.remove('bg-jjk-darker', 'text-gray-100');
                    document.body.classList.add('bg-gray-50', 'text-gray-900');
                }
                
                // Update dark mode toggle button position
                const darkToggleBall = document.querySelector('.dark-toggle-ball');
                if (darkToggleBall) {
                    if (isDarkMode) {
                        darkToggleBall.style.transform = 'translateX(24px)';
                    } else {
                        darkToggleBall.style.transform = 'translateX(0)';
                    }
                }
            }
            
            // Toggle dark mode when the switch is clicked
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.documentElement.classList.add('dark');
                    darkModeLabel.textContent = 'Light Mode';
                } else {
                    document.documentElement.classList.remove('dark');
                    darkModeLabel.textContent = 'Dark Mode';
                }
                
                applyDarkModeStyles();
            });
            
            // Initialize dark mode on page load
            initializeDarkMode();
            
            // Listen for system dark mode changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', initializeDarkMode);
            
            // Tool pricing information
            const toolPrices = {
                "Playful Cloud": 800,
                "Black Rope": 600,
                "Slaughter Demon": 1200,
                "Demon Dweller": 900,
                "Crescent Moon": 750,
                "Chain of a Thousand Miles": 850,
                "Split Soul Katana": 1000,
                "Inverted Spear of Heaven": 2000,
                "Cursed Dagger": 500,
                "Soul Cutting Blade": 1100,
                "Blood Manipulation Needles": 700,
                "Cursed Gauntlets": 750,
                "Cursed Bo Staff": 650,
                "Cursed Shuriken": 550
            };
            
            // Tool stat bonuses
            const toolStatBonuses = {
                "Playful Cloud": { strength: 3 },
                "Black Rope": { dexterity: 2, wisdom: 1 },
                "Slaughter Demon": { strength: 2, constitution: 2 },
                "Demon Dweller": { dexterity: 2, intelligence: 2 },
                "Crescent Moon": { dexterity: 3, strength: 1 },
                "Chain of a Thousand Miles": { dexterity: 2, intelligence: 1, wisdom: 1 },
                "Split Soul Katana": { dexterity: 3, intelligence: 1 },
                "Inverted Spear of Heaven": { intelligence: 3, wisdom: 2 },
                "Cursed Dagger": { dexterity: 2 },
                "Soul Cutting Blade": { intelligence: 2, wisdom: 2 },
                "Blood Manipulation Needles": { intelligence: 2, constitution: 1 },
                "Cursed Gauntlets": { strength: 2, constitution: 1 },
                "Cursed Bo Staff": { dexterity: 2, wisdom: 1 },
                "Cursed Shuriken": { dexterity: 3 }
            };
            
            // Technique energy costs
            const techniqueCosts = {
                "Limitless": 30,
                "Ten Shadows": 25,
                "Six Eyes": 15,
                "Boogie Woogie": 20,
                "Straw Doll": 20,
                "Cursed Speech": 15,
                "Blood Manipulation": 20,
                "Projection Sorcery": 25,
                "Ratio Technique": 20,
                "Copying": 25,
                "Idle Transfiguration": 30,
                "Cursed Spirit Manipulation": 25,
                "Construction": 20,
                "Disaster Flames": 25,
                "Disaster Tides": 25,
                "Disaster Plants": 20,
                "Shrine": 35,
                "Ice Formation": 20,
                "Decay": 25,
                "Ui Ui's Teleportation": 30,
                "Comedian": 15,
                "Simple Domain": 30,
                "Black Flash": 25,
                "Reverse Cursed Technique": 40,
                // Default cost for random techniques
                "random": 20
            };
            
            // Physical ability stamina costs (for heavenly restriction)
            const staminaCosts = {
                "Superhuman Strength": 15,
                "Enhanced Speed": 20,
                "Superhuman Durability": 10,
                "Enhanced Reflexes": 15
            };
            
            // Application state
            const state = {
                currentScreen: 'start',
                user: null,
                isLoggedIn: false,
                currentCharacter: null,
                stats: {
                    strength: 5,
                    dexterity: 5,
                    constitution: 5,
                    intelligence: 5,
                    wisdom: 5,
                    charisma: 5
                },
                pointsTotal: 30,
                pointsUsed: 30,
                pointsRemaining: 0,
                savedCharacters: [],
                conversationHistory: [], // Store last two messages for context
                isAwaitingResponse: false,
                appURL: window.location.href,
                
                // Resource system state
                pendingAction: null, // Stores action awaiting confirmation
                resourceRegenInterval: null, // Interval for resource regeneration
                cooldowns: {} // Tracks cooldowns for techniques/abilities
            };
            
            // Experience points needed for each level
            const xpRequirements = [
                0,       // Level 1 (starting level)
                1000,    // Level 2
                3000,    // Level 3
                6000,    // Level 4
                10000,   // Level 5
                15000,   // Level 6
                21000,   // Level 7
                28000,   // Level 8
                36000,   // Level 9
                45000,   // Level 10
                55000,   // Level 11
                66000,   // Level 12
                78000,   // Level 13
                91000,   // Level 14
                105000,  // Level 15
                120000,  // Level 16
                136000,  // Level 17
                153000,  // Level 18
                171000,  // Level 19
                190000   // Level 20
            ];

            // Grade mapping based on level
            const gradeMapping = {
                1: "Grade 4",
                3: "Grade 3",
                6: "Grade 2",
                9: "Semi-Grade 1",
                12: "Grade 1",
                16: "Special Grade"
            };
            
            // Detailed descriptions for cursed techniques
            const techniqueDescriptions = {
                "Limitless": "The ability to manipulate space at the atomic level, creating infinity between two points. Masters of this technique can create barriers that block any attack, manipulate gravity, teleport objects, and even erase matter. It's one of the most powerful innate techniques in jujutsu sorcery. Domain Expansion: Infinite Void creates a space where targets experience an infinite flood of information, paralyzing them.",
                "Ten Shadows": "Allows the user to summon and control ten different shikigami (familiar spirits) with unique abilities through shadow manipulation. Includes Divine Dogs, Nue, Toad, Great Serpent, Max Elephant, and others. Can merge shadows for stronger forms and use shadows for travel and storage. Domain Expansion: Chimera Shadow Garden creates a space where all shadows are under the user's control.",
                "Six Eyes": "A rare visual technique that grants the user the ability to see cursed energy in incredible detail and use cursed techniques with perfect efficiency. Users can see the flow of cursed energy, detect residual energy, and identify cursed techniques. Only a few sorcerers in history have possessed this technique, often paired with the Limitless technique in the Gojo clan.",
                "Boogie Woogie": "Enables the user to swap the positions of any two objects or people by clapping their hands, including themselves. The swap can be used for offensive and defensive purposes, allowing for unpredictable combat strategies and rapid movement across the battlefield. Limited by the need for physical contact or visual line of sight.",
                "Straw Doll": "Allows the user to transfer damage inflicted on a straw doll to a target whose body part (nail, hair, blood, etc.) is attached to the doll. The strength of the connection affects the amount of damage transferred. Domain Expansion: Merciful Death creates a space where anyone within is instantly connected to a straw doll for maximum damage transfer.",
                "Cursed Speech": "Words spoken by the user can compel others to follow commands, with effects varying based on the user's cursed energy and the target's resistance. Simple commands like 'Stop,' 'Don't move,' or 'Fall' can force targets to comply. More complex commands require more cursed energy and can be resisted by stronger opponents.",
                "Blood Manipulation": "Allows the user to manipulate their own blood, creating weapons, constructs, and techniques. Can form blood into various shapes like swords, spears, and arrows, control its movement, and harden it for defense. Advanced users can even control the blood of others after introducing their cursed energy into the target's bloodstream.",
                "Projection Sorcery": "The user can freeze frames of movement, allowing for incredible speed when moving according to predetermined paths. By following set rules of movement (24 frames per second), the user can appear to teleport while attacking from multiple angles. Breaking the rules results in being frozen in place momentarily.",
                "Ratio Technique": "Allows the user to change the ratio of any aspect of a target, such as strength, speed, or size. For example, can make objects heavier or lighter, slow down or speed up movement, or alter the ratio of cursed energy to physical strength.",
                "Copying": "Enables the user to copy and use the cursed techniques of others after observing them in action. The copied techniques may not be as powerful as the original but provide incredible versatility in combat. The user can store multiple techniques at once and switch between them as needed.",
                "Idle Transfiguration": "Allows the user to reshape the soul of targets by touching them, altering their body structure at will. Can transform humans into grotesque forms, heal critical injuries by reshaping the soul, or even create entirely new abilities by modifying the soul's properties.",
                "Cursed Spirit Manipulation": "The ability to control and manipulate cursed spirits after consuming them. The user can summon these spirits to fight for them and imbue their techniques with the spirits' abilities. Advanced users can store multiple spirits and access their unique powers.",
                "Construction": "Enables the user to materialize anything they imagine into reality using cursed energy. The constructs are real and physical but require concentration to maintain. More complex or larger constructs require more cursed energy and mental focus.",
                "Disaster Flames": "Control over supernatural fire that burns both physical matter and cursed energy. These flames are particularly effective against cursed spirits and can be shaped into various forms for attack and defense.",
                "Disaster Tides": "Manipulation of water with cursed properties that can drown targets even on dry land. The water can be shaped, pressurized for cutting attacks, or used to create barriers. Domain Expansion: Horizon of the Captivating Skandha creates an endless ocean where the user has absolute control.",
                "Disaster Plants": "Control over supernatural vegetation that grows rapidly and follows the user's commands. These plants can entangle, pierce, or consume opponents and are particularly effective at trapping enemies. Domain Expansion: Garden of Blooming Shadows creates a domain filled with deadly flora.",
                "Shrine": "Sukuna's technique that gives the user control over slashing attacks through two primary abilities: Dismantle and Cleave. Dismantle creates precise cuts that can slice through any material with surgical accuracy. Cleave adjusts its cutting power based on the target's durability, becoming more powerful against stronger opponents. Also grants access to Malevolent Shrine, the most refined Domain Expansion, which extends cutting attacks over a vast area while allowing the user to choose what to cut. Can also use fire arrow attacks (Kamino) for ranged combat.",
                "Ice Formation": "The ability to create and manipulate ice with cursed properties. The ice forms instantly and can be used for both offense and defense. Advanced users can freeze targets solid or create elaborate ice constructs for various tactical advantages.",
                "Decay": "Causes rapid decomposition of anything the user touches. Organic material rots away almost instantly, while inorganic materials crumble and break down. The effect spreads from the point of contact unless contained by the user.",
                "Ui Ui's Teleportation": "Allows the user to teleport themselves and anyone they're touching to any location they've previously visited. Requires physical contact with the target and a clear mental image of the destination.",
                "Comedian": "Transforms verbal jokes and puns into direct attacks. The better the joke (or worse, depending on the perspective), the more powerful the attack. Effects range from physical damage to mental confusion, depending on the nature of the humor used."
            };
            
            // Additional technique descriptions (for learning)
            const additionalTechniqueDescriptions = {
                "Cursed Speech": "Words spoken by the user can compel others to follow commands, with effects varying based on the user's cursed energy and the target's resistance. Simple commands like 'Stop,' 'Don't move,' or 'Fall' can force targets to comply. More complex commands require more cursed energy.",
                "Blood Manipulation": "Allows the user to manipulate their own blood, creating weapons, constructs, and techniques. Can form blood into various shapes like swords, spears, and arrows, control its movement, and harden it for defense.",
                "Simple Domain": "A defensive technique that creates a barrier that nullifies all domain expansions within its range. It doesn't provide the overwhelming advantage of a domain expansion but offers protection against them. Relatively easy to learn compared to other advanced techniques.",
                "Black Flash": "Not a standard technique but a phenomenon that occurs when a sorcerer perfectly times the flow of cursed energy with a physical hit. Creates an exponentially more powerful attack that deals 2.5x normal damage. Training can increase the likelihood of triggering this effect in combat.",
                "Falling Blossom Emotion": "A counter technique that allows the user to redirect an opponent's cursed energy back at them. By harmonizing with the flow of incoming energy, the user can turn the attack's power against its originator without using their own cursed energy.",
                "New Shadow Style": "A technique that allows manipulation of one's own shadow for various effects. The shadow can be used to attack, defend, scout, or transport items. Unlike the Ten Shadows technique, it doesn't summon shikigami but manipulates the shadow itself as a weapon or tool.",
                "Reverse Cursed Technique": "The ability to reverse cursed energy flow to heal injuries rather than cause harm. An advanced technique that few sorcerers master, it can heal even fatal wounds when applied correctly. Can be used on oneself or others.",
                "Binding Vow": "A pact that restricts the user in some way in exchange for increased power. The greater the restriction, the more powerful the boost. These vows are enforced by cursed energy itself and breaking them causes severe backlash.",
                "Domain Amplification": "Surrounds the user with a layer of refined cursed energy that neutralizes opponent's innate techniques when they come in contact with it. Unlike Simple Domain, it allows for offensive action while maintaining protection against most techniques."
            };
            
            // JJK Random Techniques
            const randomTechniques = [
                "Domain Expansion: Shadow Garden - Create a domain where shadows come to life and attack enemies",
                "Reverse Cursed Technique - Heal yourself and others by reversing the flow of cursed energy",
                "Cursed Tool Manipulation - Control and enhance cursed tools with your cursed energy",
                "Binding Vow - Make pacts that restrict you but enhance your power in specific ways",
                "Simple Domain - Create a barrier that neutralizes domain expansions",
                "Cursed Energy Manipulation - Shape and control cursed energy for various effects",
                "Black Flash - Land critical hits by perfectly timing cursed energy with physical attacks",
                "New Shadow Style - Control and manipulate your own shadow for attacks and defense",
                "Resonance - Amplify the cursed techniques of allies within your vicinity",
                "Cursed Energy Nullification - Temporarily nullify the cursed techniques of opponents",
                "Cursed Spirit Manipulation - Command and control lesser cursed spirits",
                "Embodiment - Temporarily take on the properties of elements or materials",
                "Dismantle - Cut anything apart at the atomic level with your cursed energy",
                "Ratio Technique - Divide and multiply properties of objects or beings",
                "Jackpot - Chance-based technique that randomly enhances your abilities",
                "Idle Transfiguration - Reshape the soul of your target, changing their appearance and abilities",
                "Maximum: Meteor - Concentrate all your cursed energy into a single devastating attack",
                "Hollow Technique - Create empty spaces or voids where nothing can exist",
                "Falling Blossom Emotion - Redirect an opponent's cursed energy back at them",
                "Inverted Spear - Nullify cursed techniques upon contact"
            ];
            
            // Detailed descriptions for cursed tools
            const toolDescriptions = {
                "Playful Cloud": "A heavy staff that increases in weight and density based on the user's cursed energy input. Originally belonging to the Zenin clan, it can crush powerful curses with devastating force. Its weight can be changed at will, making it unpredictable in combat.",
                "Black Rope": "A flexible rope that can be controlled remotely with cursed energy and bind cursed spirits. It can extend to great lengths and move with precision according to the user's will. Especially effective against curse users who rely on mobility.",
                "Slaughter Demon": "A sword that absorbs blood and grows stronger with each kill, enhancing its cutting power. The blade develops a thirst for blood and can influence its user to seek more kills. With enough blood absorbed, it can cut through even powerful curse defenses.",
                "Demon Dweller": "A katana that can store and release cursed energy in devastating attacks. The blade can absorb the user's cursed energy over time and release it in concentrated slashes that extend far beyond the physical blade.",
                "Crescent Moon": "A curved bladed weapon that can slice through cursed energy barriers and leave wounds that resist healing. Its unique shape allows it to hook and trap opponents' weapons or limbs. The cuts it makes interfere with cursed energy flow, making healing techniques less effective.",
                "Chain of a Thousand Miles": "A chain that can extend to incredible lengths and track targets once it has made contact with them. It remembers the cursed energy signature of anything it touches, allowing it to pursue targets around corners and through barriers.",
                "Split Soul Katana": "A blade that creates duplicates of itself during combat, allowing for multiple simultaneous attacks. The duplicates share the same properties as the original but disappear after striking. The number of duplicates depends on the user's cursed energy.",
                "Inverted Spear of Heaven": "One of the most powerful cursed tools, this spear can nullify any cursed technique it pierces, including domain expansions. It completely neutralizes cursed energy upon contact, making it especially effective against sorcerers who rely heavily on their techniques rather than physical combat.",
                "Cursed Dagger": "A small blade that can cut through cursed energy barriers and disrupt the flow of cursed energy in targets. Its small size makes it easy to conceal and ideal for close-quarters combat or assassination. Each cut makes it harder for the target to manipulate cursed energy effectively.",
                "Soul Cutting Blade": "A blade that can damage the soul directly, bypassing physical defenses. Wounds inflicted by this blade affect both the body and soul, making them extremely difficult to heal even with reverse cursed technique. Extended exposure can permanently damage one's ability to use cursed energy.",
                "Blood Manipulation Needles": "Set of specialized needles used by blood manipulation technique users to extend their control. When these needles pierce a target, they allow the user to manipulate the target's blood to some degree, creating a connection that's difficult to break.",
                "Cursed Gauntlets": "Gauntlets that enhance the wearer's physical strikes with explosive cursed energy. Each punch or strike releases a burst of cursed energy on impact, increasing damage significantly. Reduces the user's need to consciously channel cursed energy into attacks.",
                "Cursed Bo Staff": "A staff inscribed with cursed symbols that can extend or contract according to the user's will. Strikes from this staff disrupt the flow of cursed energy in targets temporarily. Can split into three connected sections for more versatile attack patterns.",
                "Cursed Shuriken": "Throwing weapons that track cursed energy signatures once thrown. These shuriken can change direction mid-flight to pursue targets and pierce through cursed energy barriers. Upon impact, they release a burst of cursed energy that damages the target internally."
            };
            
            // Cursed tools for random roll
            const randomTools = [
                "Playful Cloud - A heavy staff that increases in weight and density based on the user's cursed energy input. Originally belonging to the Zenin clan, it can crush powerful curses with devastating force.",
                "Black Rope - A flexible rope that can be controlled remotely with cursed energy and bind cursed spirits.",
                "Slaughter Demon - A sword that absorbs blood and grows stronger with each kill, enhancing its cutting power.",
                "Demon Dweller - A katana that can store and release cursed energy in devastating attacks.",
                "Crescent Moon - A curved bladed weapon that can slice through cursed energy barriers and leave wounds that resist healing.",
                "Chain of a Thousand Miles - A chain that can extend to incredible lengths and track targets once it has made contact with them.",
                "Split Soul Katana - A blade that creates duplicates of itself during combat, allowing for multiple simultaneous attacks.",
                "Inverted Spear of Heaven - One of the most powerful cursed tools, this spear can nullify any cursed technique it pierces, including domain expansions.",
                "Cursed Dagger - A small blade that can cut through cursed energy barriers and disrupt the flow of cursed energy in targets.",
                "Soul Cutting Blade - A blade that can damage the soul directly, bypassing physical defenses.",
                "Blood Manipulation Needles - Set of specialized needles used by blood manipulation technique users to extend their control.",
                "Cursed Gauntlets - Gauntlets that enhance the wearer's physical strikes with explosive cursed energy.",
                "Cursed Bo Staff - A staff inscribed with cursed symbols that can extend or contract according to the user's will.",
                "Cursed Shuriken - Throwing weapons that track cursed energy signatures once thrown."
            ];
            
            // Format stat bonuses for display
            function formatStatBonuses(bonuses) {
                if (!bonuses) return '';
                
                const bonusStrings = [];
                for (const [stat, value] of Object.entries(bonuses)) {
                    let statName = '';
                    switch (stat) {
                        case 'strength': statName = 'STR'; break;
                        case 'dexterity': statName = 'DEX'; break;
                        case 'constitution': statName = 'CON'; break;
                        case 'intelligence': statName = 'INT'; break;
                        case 'wisdom': statName = 'WIS'; break;
                        case 'charisma': statName = 'CHA'; break;
                    }
                    bonusStrings.push(`+${value} ${statName}`);
                }
                
                return bonusStrings.join(', ');
            }
            
            // Screen navigation functions
            function showScreen(screenId) {
                // Hide all screens
                document.getElementById('startScreen').classList.add('hidden');
                document.getElementById('characterCreationScreen').classList.add('hidden');
                document.getElementById('characterOverviewScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('shopScreen').classList.add('hidden');
                
                // Show the requested screen
                document.getElementById(screenId).classList.remove('hidden');
                state.currentScreen = screenId.replace('Screen', '');
                
                // Special handling for specific screens
                if (screenId === 'characterOverviewScreen') {
                    updateCharacterOverview();
                } else if (screenId === 'shopScreen') {
                    updateShopDisplay();
                } else if (screenId === 'gameScreen') {
                    // Start resource regeneration
                    startResourceRegeneration();
                }
                
                console.log("Current screen:", state.currentScreen);
            }
            
            // Start resource regeneration loop
            function startResourceRegeneration() {
                // Clear any existing interval
                if (state.resourceRegenInterval) {
                    clearInterval(state.resourceRegenInterval);
                }
                
                // Set up interval for passive regeneration
                state.resourceRegenInterval = setInterval(() => {
                    if (!state.currentCharacter) return;
                    
                    const character = state.currentCharacter;
                    
                    // Regenerate health (very slowly)
                    if (character.gameProgress.health.current < character.gameProgress.health.max) {
                        character.gameProgress.health.current = Math.min(
                            character.gameProgress.health.current + 1,
                            character.gameProgress.health.max
                        );
                    }
                    
                    // For sorcerers: regenerate cursed energy
                    if (character.characterType === 'Sorcerer' && 
                        character.gameProgress.cursedEnergy.current < character.gameProgress.cursedEnergy.max) {
                        character.gameProgress.cursedEnergy.current = Math.min(
                            character.gameProgress.cursedEnergy.current + 2,
                            character.gameProgress.cursedEnergy.max
                        );
                    }
                    
                    // For heavenly restriction: regenerate stamina
                    if (character.characterType === 'HeavenlyRestriction' && 
                        character.gameProgress.stamina.current < character.gameProgress.stamina.max) {
                        character.gameProgress.stamina.current = Math.min(
                            character.gameProgress.stamina.current + 3,
                            character.gameProgress.stamina.max
                        );
                    }
                    
                    // Update the UI
                    updateResourceBars();
                    
                    // Process cooldowns
                    processCooldowns();
                    
                }, 3000); // Update every 3 seconds
            }
            
            // Process and update cooldowns
            function processCooldowns() {
                if (!state.cooldowns) return;
                
                const now = Date.now();
                let updated = false;
                
                for (const [abilityId, cooldownInfo] of Object.entries(state.cooldowns)) {
                    if (cooldownInfo.endsAt <= now) {
                        // Cooldown has expired
                        delete state.cooldowns[abilityId];
                        updated = true;
                        
                        // Remove cooldown overlay from ability button
                        const abilityBtn = document.getElementById(`use-${abilityId}-btn`);
                        if (abilityBtn) {
                            const overlay = abilityBtn.querySelector('.cooldown-overlay');
                            if (overlay) {
                                overlay.remove();
                            }
                            abilityBtn.disabled = false;
                            abilityBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    } else {
                        // Update cooldown visual
                        const abilityBtn = document.getElementById(`use-${abilityId}-btn`);
                        if (abilityBtn) {
                            let overlay = abilityBtn.querySelector('.cooldown-overlay');
                            if (!overlay) {
                                overlay = document.createElement('div');
                                overlay.className = 'cooldown-overlay';
                                abilityBtn.appendChild(overlay);
                                abilityBtn.disabled = true;
                                abilityBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            }
                            
                            // Calculate remaining percentage
                            const totalDuration = cooldownInfo.duration;
                            const elapsed = now - cooldownInfo.startedAt;
                            const remaining = cooldownInfo.endsAt - now;
                            const percentRemaining = (remaining / totalDuration) * 100;
                            
                            overlay.style.height = `${percentRemaining}%`;
                        }
                    }
                }
                
                if (updated && state.isLoggedIn && state.user && state.currentCharacter) {
                    // Save cooldown changes to character
                    state.currentCharacter.gameProgress.cooldowns = state.cooldowns;
                    saveCharacterToUser(state.currentCharacter);
                }
            }
            
            // Apply cooldown to an ability
            function applyCooldown(abilityId, durationMs) {
                if (!state.cooldowns) {
                    state.cooldowns = {};
                }
                
                const now = Date.now();
                state.cooldowns[abilityId] = {
                    startedAt: now,
                    endsAt: now + durationMs,
                    duration: durationMs
                };
                
                // Apply cooldown visually
                const abilityBtn = document.getElementById(`use-${abilityId}-btn`);
                if (abilityBtn) {
                    const overlay = document.createElement('div');
                    overlay.className = 'cooldown-overlay';
                    abilityBtn.appendChild(overlay);
                    abilityBtn.disabled = true;
                    abilityBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    
                    // Animate cooldown
                    overlay.style.height = '100%';
                }
                
                // Save cooldown to character
                if (state.currentCharacter) {
                    state.currentCharacter.gameProgress.cooldowns = state.cooldowns;
                    
                    if (state.isLoggedIn && state.user) {
                        saveCharacterToUser(state.currentCharacter);
                    }
                }
            }
            
            // Update all resource bars in the UI
            function updateResourceBars() {
                if (!state.currentCharacter) return;
                
                const character = state.currentCharacter;
                
                // Update health bars
                const healthPercent = (character.gameProgress.health.current / character.gameProgress.health.max) * 100;
                
                // Main panel health
                const healthBar = document.getElementById('health-bar');
                const healthValue = document.getElementById('health-value');
                if (healthBar && healthValue) {
                    healthBar.style.width = `${healthPercent}%`;
                    healthValue.textContent = `${character.gameProgress.health.current}/${character.gameProgress.health.max}`;
                    
                    // Update color based on health
                    if (healthPercent <= 25) {
                        healthBar.classList.remove('bg-green-500', 'bg-yellow-500');
                        healthBar.classList.add('bg-red-500');
                    } else if (healthPercent <= 60) {
                        healthBar.classList.remove('bg-green-500', 'bg-red-500');
                        healthBar.classList.add('bg-yellow-500');
                    } else {
                        healthBar.classList.remove('bg-yellow-500', 'bg-red-500');
                        healthBar.classList.add('bg-green-500');
                    }
                }
                
                // Mini health bar
                const miniHealthBar = document.getElementById('mini-health-bar');
                const miniHealth = document.getElementById('mini-health');
                if (miniHealthBar && miniHealth) {
                    miniHealthBar.style.width = `${healthPercent}%`;
                    miniHealth.textContent = character.gameProgress.health.current;
                    
                    // Update color based on health
                    if (healthPercent <= 25) {
                        miniHealthBar.classList.remove('bg-green-500', 'bg-yellow-500');
                        miniHealthBar.classList.add('bg-red-500');
                    } else if (healthPercent <= 60) {
                        miniHealthBar.classList.remove('bg-green-500', 'bg-red-500');
                        miniHealthBar.classList.add('bg-yellow-500');
                    } else {
                        miniHealthBar.classList.remove('bg-yellow-500', 'bg-red-500');
                        miniHealthBar.classList.add('bg-green-500');
                    }
                }
                
                // Update sheet health bar
                const sheetHealthBar = document.getElementById('sheet-health-bar');
                const sheetHealth = document.getElementById('sheet-health');
                if (sheetHealthBar && sheetHealth) {
                    sheetHealthBar.style.width = `${healthPercent}%`;
                    sheetHealth.textContent = `${character.gameProgress.health.current}/${character.gameProgress.health.max}`;
                }
                
                // For sorcerers: update cursed energy
                if (character.characterType === 'Sorcerer') {
                    const energyPercent = (character.gameProgress.cursedEnergy.current / character.gameProgress.cursedEnergy.max) * 100;
                    
                    // Main energy bar
                    const energyBar = document.getElementById('energy-bar');
                    const energyValue = document.getElementById('energy-value');
                    if (energyBar && energyValue) {
                        energyBar.style.width = `${energyPercent}%`;
                        energyValue.textContent = `${character.gameProgress.cursedEnergy.current}/${character.gameProgress.cursedEnergy.max}`;
                    }
                    
                    // Mini energy bar
                    const miniEnergyBar = document.getElementById('mini-energy-bar');
                    const miniEnergy = document.getElementById('mini-energy');
                    if (miniEnergyBar && miniEnergy) {
                        miniEnergyBar.style.width = `${energyPercent}%`;
                        miniEnergy.textContent = character.gameProgress.cursedEnergy.current;
                    }
                    
                    // Sheet energy bar
                    const sheetEnergyBar = document.getElementById('sheet-energy-bar');
                    const sheetEnergy = document.getElementById('sheet-energy');
                    if (sheetEnergyBar && sheetEnergy) {
                        sheetEnergyBar.style.width = `${energyPercent}%`;
                        sheetEnergy.textContent = `${character.gameProgress.cursedEnergy.current}/${character.gameProgress.cursedEnergy.max}`;
                    }
                    
                    // Show energy, hide stamina
                    document.getElementById('energy-container').classList.remove('hidden');
                    document.getElementById('stamina-container').classList.add('hidden');
                    document.getElementById('mini-energy-container').classList.remove('hidden');
                    document.getElementById('mini-stamina-container').classList.add('hidden');
                    document.getElementById('sheet-energy-container').classList.remove('hidden');
                    document.getElementById('sheet-stamina-container').classList.add('hidden');
                }
                
                // For heavenly restriction: update stamina
                if (character.characterType === 'HeavenlyRestriction') {
                    const staminaPercent = (character.gameProgress.stamina.current / character.gameProgress.stamina.max) * 100;
                    
                    // Main stamina bar
                    const staminaBar = document.getElementById('stamina-bar');
                    const staminaValue = document.getElementById('stamina-value');
                    if (staminaBar && staminaValue) {
                        staminaBar.style.width = `${staminaPercent}%`;
                        staminaValue.textContent = `${character.gameProgress.stamina.current}/${character.gameProgress.stamina.max}`;
                    }
                    
                    // Mini stamina bar
                    const miniStaminaBar = document.getElementById('mini-stamina-bar');
                    const miniStamina = document.getElementById('mini-stamina');
                    if (miniStaminaBar && miniStamina) {
                        miniStaminaBar.style.width = `${staminaPercent}%`;
                        miniStamina.textContent = character.gameProgress.stamina.current;
                    }
                    
                    // Sheet stamina bar
                    const sheetStaminaBar = document.getElementById('sheet-stamina-bar');
                    const sheetStamina = document.getElementById('sheet-stamina');
                    if (sheetStaminaBar && sheetStamina) {
                        sheetStaminaBar.style.width = `${staminaPercent}%`;
                        sheetStamina.textContent = `${character.gameProgress.stamina.current}/${character.gameProgress.stamina.max}`;
                    }
                    
                    // Show stamina, hide energy
                    document.getElementById('energy-container').classList.add('hidden');
                    document.getElementById('stamina-container').classList.remove('hidden');
                    document.getElementById('mini-energy-container').classList.add('hidden');
                    document.getElementById('mini-stamina-container').classList.remove('hidden');
                    document.getElementById('sheet-energy-container').classList.add('hidden');
                    document.getElementById('sheet-stamina-container').classList.remove('hidden');
                }
            }
            
            // Show character sheet modal
            function showCharacterSheet() {
                if (!state.currentCharacter) return;
                
                // Update sheet data
                updateCharacterSheet();
                
                // Show the modal
                document.getElementById('characterSheetModal').classList.remove('hidden');
            }
            
            // Hide character sheet modal
            function hideCharacterSheet() {
                document.getElementById('characterSheetModal').classList.add('hidden');
            }
            
            // Update character sheet
            function updateCharacterSheet() {
                if (!state.currentCharacter) return;
                
                const character = state.currentCharacter;
                
                // Basic info
                document.getElementById('sheet-name').textContent = character.name;
                document.getElementById('sheet-background').textContent = character.background;
                document.getElementById('sheet-grade').textContent = character.gameProgress.grade;
                
                // Health
                const healthPercent = (character.gameProgress.health.current / character.gameProgress.health.max) * 100;
                document.getElementById('sheet-health').textContent = `${character.gameProgress.health.current}/${character.gameProgress.health.max}`;
                document.getElementById('sheet-health-bar').style.width = `${healthPercent}%`;
                
                // Change title based on character type
                if (character.characterType === 'Sorcerer') {
                    document.getElementById('sheet-abilities-title').textContent = 'Cursed Technique';
                    document.getElementById('sheet-technique-type').textContent = character.techniqueType + ' Technique';
                    
                    // Show energy cost
                    const techniqueId = character.cursedTechnique.split(' - ')[0];
                    const energyCost = techniqueCosts[techniqueId] || 20;
                    document.getElementById('sheet-technique-cost').classList.remove('hidden');
                    document.getElementById('sheet-cost-value').textContent = energyCost;
                    
                    // Energy
                    const energyPercent = (character.gameProgress.cursedEnergy.current / character.gameProgress.cursedEnergy.max) * 100;
                    document.getElementById('sheet-energy').textContent = `${character.gameProgress.cursedEnergy.current}/${character.gameProgress.cursedEnergy.max}`;
                    document.getElementById('sheet-energy-bar').style.width = `${energyPercent}%`;
                    
                    // Show energy, hide stamina
                    document.getElementById('sheet-energy-container').classList.remove('hidden');
                    document.getElementById('sheet-stamina-container').classList.add('hidden');
                } else {
                    document.getElementById('sheet-abilities-title').textContent = 'Heavenly Restriction';
                    document.getElementById('sheet-technique-type').textContent = 'Heavenly Restriction';
                    
                    // Hide energy cost
                    document.getElementById('sheet-technique-cost').classList.add('hidden');
                    
                    // Stamina
                    const staminaPercent = (character.gameProgress.stamina.current / character.gameProgress.stamina.max) * 100;
                    document.getElementById('sheet-stamina').textContent = `${character.gameProgress.stamina.current}/${character.gameProgress.stamina.max}`;
                    document.getElementById('sheet-stamina-bar').style.width = `${staminaPercent}%`;
                    
                    // Show stamina, hide energy
                    document.getElementById('sheet-energy-container').classList.add('hidden');
                    document.getElementById('sheet-stamina-container').classList.remove('hidden');
                }
                
                // Technique
                document.getElementById('sheet-technique').textContent = character.cursedTechnique;
                
                // XP and level
                const currentLevel = character.gameProgress.level;
                const currentXP = character.gameProgress.experience;
                const currentLevelXP = xpRequirements[currentLevel - 1];
                const nextLevelXP = currentLevel < 20 ? xpRequirements[currentLevel] : currentLevelXP;
                const xpProgress = ((currentXP - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;
                
                document.getElementById('sheet-xp').textContent = `${currentXP}/${nextLevelXP}`;
                document.getElementById('sheet-xp-bar').style.width = `${currentLevel >= 20 ? 100 : xpProgress}%`;
                
                // Stats
                document.getElementById('sheet-str').textContent = character.stats.strength;
                document.getElementById('sheet-dex').textContent = character.stats.dexterity;
                document.getElementById('sheet-con').textContent = character.stats.constitution;
                document.getElementById('sheet-int').textContent = character.stats.intelligence;
                document.getElementById('sheet-wis').textContent = character.stats.wisdom;
                document.getElementById('sheet-cha').textContent = character.stats.charisma;
                
                // Tool
                const toolName = character.cursedTool;
                if (toolName && toolName !== 'none') {
                    document.getElementById('sheet-tool-name').textContent = toolName;
                    document.getElementById('sheet-tool-desc').textContent = character.cursedToolDescription;
                } else {
                    document.getElementById('sheet-tool-name').textContent = 'None';
                    document.getElementById('sheet-tool-desc').textContent = 'No tool equipped';
                }
                
                // Money
                document.getElementById('sheet-money').textContent = `${character.gameProgress.money || 500} ¥`;
                
                // Portrait
                const sheetPortrait = document.getElementById('sheet-portrait');
                if (character.portrait) {
                    sheetPortrait.innerHTML = `<img src="${character.portrait}" class="w-full h-full object-cover" alt="${character.name}">`;
                }
            }
            
            // Update shop display
            function updateShopDisplay() {
                if (!state.currentCharacter) return;
                
                // Update money display
                document.getElementById('shopMoney').textContent = `${state.currentCharacter.gameProgress.money || 500} ¥`;
                
                // Update inventory tab
                updateShopInventory();
            }
            
            // Update shop inventory tab
            function updateShopInventory() {
                if (!state.currentCharacter) return;
                
                const inventory = state.currentCharacter.gameProgress.inventory || [];
                const inventoryContainer = document.getElementById('shopInventoryItems');
                const emptyInventoryMsg = document.getElementById('emptyShopInventoryMsg');
                
                // Clear container
                while (inventoryContainer.children.length > 1) {
                    inventoryContainer.removeChild(inventoryContainer.lastChild);
                }
                
                if (inventory.length === 0) {
                    emptyInventoryMsg.classList.remove('hidden');
                    return;
                }
                
                emptyInventoryMsg.classList.add('hidden');
                
                // Find equipped item
                const equippedItem = inventory.find(item => item.equipped);
                
                // Update equipped section
                const equippedToolName = document.getElementById('shopEquippedToolName');
                const equippedToolDescription = document.getElementById('shopEquippedToolDescription');
                
                if (equippedItem) {
                    equippedToolName.textContent = equippedItem.name;
                    equippedToolDescription.textContent = equippedItem.description;
                } else {
                    equippedToolName.textContent = "No Item Equipped";
                    equippedToolDescription.textContent = "Equip an item from your inventory";
                }
                
                // Add inventory items
                inventory.filter(item => !item.equipped).forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
                    
                    let bonusHtml = '';
                    if (item.bonuses) {
                        bonusHtml = `<div class="text-xs text-green-600 dark:text-green-400 mt-1">${formatStatBonuses(item.bonuses)}</div>`;
                    }
                    
                    let costHtml = '';
                    if (item.type === 'technique' && item.cost) {
                        costHtml = `<div class="text-xs text-blue-600 dark:text-blue-400 mt-1">Cost: ${item.cost} Cursed Energy</div>`;
                    }
                    
                    itemElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium">${item.name}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${item.description}</p>
                                ${bonusHtml}
                                ${costHtml}
                            </div>
                            <div class="flex space-x-2">
                                <button class="shop-equip-btn text-green-500 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 p-1 rounded" data-item-id="${item.id}" title="Equip">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    inventoryContainer.appendChild(itemElement);
                });
                
                // Attach equip event listeners
                document.querySelectorAll('.shop-equip-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const itemId = btn.dataset.itemId;
                        equipItem(itemId);
                    });
                });
            }
            
            // Equip an item
            function equipItem(itemId) {
                if (!state.currentCharacter) return;
                
                const inventory = state.currentCharacter.gameProgress.inventory || [];
                
                // Unequip current item if any
                inventory.forEach(item => {
                    if (item.equipped) item.equipped = false;
                });
                
                // Equip new item
                const itemToEquip = inventory.find(item => item.id === itemId);
                if (itemToEquip) {
                    itemToEquip.equipped = true;
                    
                    // Save changes
                    if (state.isLoggedIn && state.user) {
                        saveCharacterToUser(state.currentCharacter);
                    }
                    
                    // Update UI
                    updateShopInventory();
                    showToast('Item Equipped', `${itemToEquip.name} has been equipped`, 'success');
                }
            }
            
            // Display a toast notification
            function showToast(title, message, type = 'success', duration = 3000) {
                const toast = document.getElementById('toast');
                const toastTitle = document.getElementById('toastTitle');
                const toastMessage = document.getElementById('toastMessage');
                const toastIcon = document.getElementById('toastIcon');
                
                toastTitle.textContent = title;
                toastMessage.textContent = message;
                
                // Set the icon based on the type
                let icon = '';
                if (type === 'success') {
                    icon = '<svg class="text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" /></svg>';
                } else if (type === 'error') {
                    icon = '<svg class="text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.72 6.97a.75.75 0 10-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 101.06 1.06L12 13.06l1.72 1.72a.75.75 0 101.06-1.06L13.06 12l1.72-1.72a.75.75 0 10-1.06-1.06L12 10.94l-1.72-1.72z" clip-rule="evenodd" /></svg>';
                } else if (type === 'warning') {
                    icon = '<svg class="text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>';
                } else if (type === 'info') {
                    icon = '<svg class="text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>';
                }
                toastIcon.innerHTML = icon;
                
                // Show the toast
                toast.classList.remove('translate-y-full', 'opacity-0');
                
                // Hide after duration
                setTimeout(() => {
                    toast.classList.add('translate-y-full', 'opacity-0');
                }, duration);
            }
            
            // Show resource confirmation modal
            function showResourceConfirmation(action, resourceType, cost, currentValue, maxValue) {
                const modal = document.getElementById('resourceConfirmModal');
                const title = document.getElementById('resource-action-title');
                const desc = document.getElementById('resource-action-desc');
                const energyContainer = document.getElementById('energy-cost-container');
                const staminaContainer = document.getElementById('stamina-cost-container');
                
                // Set action info
                title.textContent = action.title || 'Confirm Action';
                desc.textContent = action.description || 'Are you sure you want to perform this action?';
                
                // Set resource info based on type
                if (resourceType === 'energy') {
                    energyContainer.classList.remove('hidden');
                    staminaContainer.classList.add('hidden');
                    
                    document.getElementById('confirm-energy-cost').textContent = cost;
                    document.getElementById('confirm-current-energy').textContent = currentValue;
                    document.getElementById('confirm-max-energy').textContent = maxValue;
                } else if (resourceType === 'stamina') {
                    energyContainer.classList.add('hidden');
                    staminaContainer.classList.remove('hidden');
                    
                    document.getElementById('confirm-stamina-cost').textContent = cost;
                    document.getElementById('confirm-current-stamina').textContent = currentValue;
                    document.getElementById('confirm-max-stamina').textContent = maxValue;
                }
                
                // Store action in state for later execution
                state.pendingAction = action;
                
                // Show modal
                modal.classList.remove('hidden');
            }
            
            // Hide resource confirmation modal
            function hideResourceConfirmation() {
                document.getElementById('resourceConfirmModal').classList.add('hidden');
                state.pendingAction = null;
            }
            
            // Use technique with resource cost
            function useTechnique(techniqueId) {
                if (!state.currentCharacter) return;
                
                const character = state.currentCharacter;
                
                // For sorcerers: check cursed energy
                if (character.characterType === 'Sorcerer') {
                    const energyCost = techniqueCosts[techniqueId] || 20;
                    
                    if (character.gameProgress.cursedEnergy.current < energyCost) {
                        // Not enough energy!
                        showToast('Not enough cursed energy', 'You need more cursed energy to use this technique', 'error');
                        
                        // Visual feedback - shake energy bar
                        const energyBar = document.getElementById('energy-bar');
                        if (energyBar) {
                            energyBar.parentElement.classList.add('shake');
                            setTimeout(() => {
                                energyBar.parentElement.classList.remove('shake');
                            }, 500);
                        }
                        return false;
                    }
                    
                    // Prepare confirmation
                    const action = {
                        title: `Use ${techniqueId}`,
                        description: `Are you sure you want to use ${techniqueId}? This will consume ${energyCost} cursed energy.`,
                        execute: () => {
                            // Deduct energy
                            character.gameProgress.cursedEnergy.current -= energyCost;
                            
                            // Update UI
                            updateResourceBars();
                            
                            // Apply cooldown (10 seconds)
                            applyCooldown('technique', 10000);
                            
                            // Send message to AI
                            const actionDescription = `I use my ${techniqueId} technique, channeling ${energyCost} units of cursed energy.`;
                            
                            // Add to game messages
                            addGameMessage('player', actionDescription);
                            
                            // Submit to AI
                            submitActionToAI(actionDescription);
                            
                            // Auto-save
                            if (state.isLoggedIn && state.user) {
                                saveCharacterToUser(character);
                            }
                            
                            return true;
                        }
                    };
                    
                    // Show confirmation
                    showResourceConfirmation(
                        action,
                        'energy',
                        energyCost,
                        character.gameProgress.cursedEnergy.current,
                        character.gameProgress.cursedEnergy.max
                    );
                    
                    return true;
                }
                
                return false;
            }
            
            // Use physical ability with stamina cost (for heavenly restriction)
            function usePhysicalAbility(abilityId) {
                if (!state.currentCharacter) return;
                
                const character = state.currentCharacter;
                
                // Only for heavenly restriction characters
                if (character.characterType === 'HeavenlyRestriction') {
                    const staminaCost = staminaCosts[abilityId] || 15;
                    
                    if (character.gameProgress.stamina.current < staminaCost) {
                        // Not enough stamina!
                        showToast('Not enough stamina', 'You need more stamina to use this ability', 'error');
                        
                        // Visual feedback - shake stamina bar
                        const staminaBar = document.getElementById('stamina-bar');
                        if (staminaBar) {
                            staminaBar.parentElement.classList.add('shake');
                            setTimeout(() => {
                                staminaBar.parentElement.classList.remove('shake');
                            }, 500);
                        }
                        return false;
                    }
                    
                    // Prepare confirmation
                    const action = {
                        title: `Use ${abilityId}`,
                        description: `Are you sure you want to use ${abilityId}? This will consume ${staminaCost} stamina.`,
                        execute: () => {
                            // Deduct stamina
                            character.gameProgress.stamina.current -= staminaCost;
                            
                            // Update UI
                            updateResourceBars();
                            
                            // Apply cooldown (varies by ability)
                            let cooldownTime = 8000; // default 8 seconds
                            if (abilityId === 'Enhanced Speed') cooldownTime = 5000; // 5 seconds
                            if (abilityId === 'Superhuman Durability') cooldownTime = 15000; // 15 seconds
                            
                            applyCooldown(abilityId.toLowerCase().replace(/\s+/g, '-'), cooldownTime);
                            
                            // Send message to AI
                            const actionDescription = `I use my ${abilityId}, exerting ${staminaCost} stamina points.`;
                            
                            // Add to game messages
                            addGameMessage('player', actionDescription);
                            
                            // Submit to AI
                            submitActionToAI(actionDescription);
                            
                            // Auto-save
                            if (state.isLoggedIn && state.user) {
                                saveCharacterToUser(character);
                            }
                            
                            return true;
                        }
                    };
                    
                    // Show confirmation
                    showResourceConfirmation(
                        action,
                        'stamina',
                        staminaCost,
                        character.gameProgress.stamina.current,
                        character.gameProgress.stamina.max
                    );
                    
                    return true;
                }
                
                return false;
            }
            
            // Rest action to recover resources
            function restAndRecover() {
                if (!state.currentCharacter) return;
                
                const character = state.currentCharacter;
                
                // Show confirmation
                const action = {
                    title: 'Rest & Recover',
                    description: 'Take time to rest and recover your resources. This will restore some health and energy/stamina.',
                    execute: () => {
                        // Restore health (25%)
                        const healthRestore = Math.floor(character.gameProgress.health.max * 0.25);
                        character.gameProgress.health.current = Math.min(
                            character.gameProgress.health.current + healthRestore,
                            character.gameProgress.health.max
                        );
                        
                        // Restore energy/stamina (50%)
                        if (character.characterType === 'Sorcerer') {
                            const energyRestore = Math.floor(character.gameProgress.cursedEnergy.max * 0.5);
                            character.gameProgress.cursedEnergy.current = Math.min(
                                character.gameProgress.cursedEnergy.current + energyRestore,
                                character.gameProgress.cursedEnergy.max
                            );
                        } else {
                            const staminaRestore = Math.floor(character.gameProgress.stamina.max * 0.5);
                            character.gameProgress.stamina.current = Math.min(
                                character.gameProgress.stamina.current + staminaRestore,
                                character.gameProgress.stamina.max
                            );
                        }
                        
                        // Update UI
                        updateResourceBars();
                        
                        // Apply cooldown
                        applyCooldown('rest', 30000); // 30 seconds cooldown
                        
                        // Send message to AI
                        const actionDescription = "I take a moment to rest and recover my strength.";
                        
                        // Add to game messages
                        addGameMessage('player', actionDescription);
                        
                        // Submit to AI
                        submitActionToAI(actionDescription);
                        
                        // Show feedback
                        showToast(
                            'Rested Successfully', 
                            `Recovered ${healthRestore} health and ${character.characterType === 'Sorcerer' ? 'energy' : 'stamina'}.`,
                            'success'
                        );
                        
                        // Auto-save
                        if (state.isLoggedIn && state.user) {
                            saveCharacterToUser(character);
                        }
                        
                        return true;
                    }
                };
                
                // Execute directly without confirmation
                action.execute();
            }
            
            // Authentication functions
            function showAuthModal(tab = 'login') {
                const authModal = document.getElementById('authModal');
                const loginTabBtn = document.getElementById('loginTabBtn');
                const signupTabBtn = document.getElementById('signupTabBtn');
                const loginForm = document.getElementById('loginForm');
                const signupForm = document.getElementById('signupForm');
                
                authModal.classList.remove('hidden');
                
                if (tab === 'login') {
                    loginTabBtn.classList.add('bg-primary', 'text-white');
                    signupTabBtn.classList.remove('bg-primary', 'text-white');
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                } else {
                    signupTabBtn.classList.add('bg-primary', 'text-white');
                    loginTabBtn.classList.remove('bg-primary', 'text-white');
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                }
            }
            
            function hideAuthModal() {
                const authModal = document.getElementById('authModal');
                authModal.classList.add('hidden');
                
                // Clear form fields
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('signupUsername').value = '';
                document.getElementById('signupPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            }
            
            function login(username, password) {
                // In a real app, this would make an API call
                // For this demo, we'll simulate local storage
                const users = JSON.parse(localStorage.getItem('jjkDndUsers') || '[]');
                const user = users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    state.user = { username: user.username, id: user.id };
                    state.isLoggedIn = true;
                    state.savedCharacters = user.characters || [];
                    
                    // Load conversation history if exists
                    if (user.conversationHistory) {
                        state.conversationHistory = user.conversationHistory;
                    }
                    
                    document.getElementById('userControls').classList.add('hidden');
                    document.getElementById('userInfo').classList.remove('hidden');
                    document.getElementById('username').textContent = user.username;
                    
                    hideAuthModal();
                    showToast('Login Successful', 'Welcome back, ' + user.username + '!');
                    
                    return true;
                } else {
                    showToast('Login Failed', 'Invalid username or password', 'error');
                    return false;
                }
            }
            
            function signup(username, password) {
                // In a real app, this would make an API call
                // For this demo, we'll simulate local storage
                const users = JSON.parse(localStorage.getItem('jjkDndUsers') || '[]');
                
                // Check if username already exists
                if (users.some(u => u.username === username)) {
                    showToast('Signup Failed', 'Username already exists', 'error');
                    return false;
                }
                
                // Create new user
                const newUser = {
                    id: Date.now().toString(),
                    username,
                    password,
                    characters: [],
                    conversationHistory: []
                };
                
                users.push(newUser);
                localStorage.setItem('jjkDndUsers', JSON.stringify(users));
                
                // Auto login
                state.user = { username: newUser.username, id: newUser.id };
                state.isLoggedIn = true;
                state.savedCharacters = [];
                state.conversationHistory = [];
                
                document.getElementById('userControls').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('username').textContent = newUser.username;
                
                hideAuthModal();
                showToast('Account Created', 'Welcome to JuJutsu Kaisen D&D!');
                
                return true;
            }
            
            function logout() {
                // Save conversation history before logging out
                if (state.isLoggedIn && state.user && state.conversationHistory.length > 0) {
                    saveConversationHistory();
                }
                
                state.user = null;
                state.isLoggedIn = false;
                state.savedCharacters = [];
                state.conversationHistory = [];
                
                document.getElementById('userControls').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
                
                // Stop resource regeneration
                if (state.resourceRegenInterval) {
                    clearInterval(state.resourceRegenInterval);
                    state.resourceRegenInterval = null;
                }
                
                showToast('Logged Out', 'You have been logged out successfully');
                
                // If we're in a screen that requires login, go back to start
                if (state.currentScreen === 'game') {
                    showScreen('startScreen');
                }
            }
            
            // Save conversation history to user account
            function saveConversationHistory() {
                if (!state.isLoggedIn || !state.user) return;
                
                const users = JSON.parse(localStorage.getItem('jjkDndUsers') || '[]');
                const userIndex = users.findIndex(u => u.username === state.user.username);
                
                if (userIndex === -1) return;
                
                // Keep only the latest 2 messages
                const historyToSave = state.conversationHistory.slice(-2);
                
                users[userIndex].conversationHistory = historyToSave;
                localStorage.setItem('jjkDndUsers', JSON.stringify(users));
                
                console.log("Saved conversation history:", historyToSave);
            }
            
            // Get grade based on level
            function getGradeFromLevel(level) {
                let grade = "Grade 4"; // Default grade
                
                // Find the highest grade that the level qualifies for
                for (let requiredLevel in gradeMapping) {
                    if (level >= parseInt(requiredLevel)) {
                        grade = gradeMapping[requiredLevel];
                    }
                }
                
                return grade;
            }

            // Character functions
            function createCharacter(formData) {
                // Get character type
                const characterType = formData.get('characterType');
                
                // Get tool info
                const toolName = formData.get('cursedToolSelect');
                const toolPrice = toolName && toolName !== 'none' && toolName !== 'random' ? toolPrices[toolName] || 0 : 0;
                
                // Calculate health and cursed energy based on stats
                const constitution = parseInt(formData.get('constitutionStat'));
                const wisdom = parseInt(formData.get('wisdomStat'));
                const maxHealth = 80 + (constitution * 10); // Base health + bonus from constitution
                
                // Get profile image if available
                let profileImageUrl = null;
                const profilePicturePreview = document.getElementById('profilePicturePreview');
                if (profilePicturePreview.querySelector('img')) {
                    profileImageUrl = profilePicturePreview.querySelector('img').src;
                }
                
                // Get tool bonuses if applicable
                let toolBonuses = null;
                if (toolName && toolName !== 'none' && toolName !== 'random') {
                    toolBonuses = toolStatBonuses[toolName] || null;
                }
                
                // Calculate starting money (subtract tool price)
                const startingMoney = 500 - toolPrice;
                
                // Get technique cost if it's a sorcerer
                let techniqueCost = 0;
                if (characterType === 'Sorcerer') {
                    const techniqueId = formData.get('techniqueSelect');
                    techniqueCost = techniqueCosts[techniqueId] || 20;
                }
                
                const character = {
                    id: Date.now().toString(),
                    name: formData.get('charName'),
                    gender: formData.get('charGender'),
                    background: formData.get('charBackground'),
                    characterType: characterType,
                    techniqueType: formData.get('techniqueType'),
                    cursedTechnique: formData.get('cursedTechnique'),
                    cursedTechniqueCost: techniqueCost,
                    cursedTool: formData.get('cursedToolSelect'),
                    cursedToolDescription: formData.get('cursedToolDescription'),
                    cursedToolBonuses: toolBonuses,
                    additionalTechniques: [],
                    stats: {
                        strength: parseInt(formData.get('strengthStat')),
                        dexterity: parseInt(formData.get('dexterityStat')),
                        constitution: parseInt(formData.get('constitutionStat')),
                        intelligence: parseInt(formData.get('intelligenceStat')),
                        wisdom: parseInt(formData.get('wisdomStat')),
                        charisma: parseInt(formData.get('charismaStat'))
                    },
                    gameProgress: {
                        currentScene: 'start',
                        inventory: [],
                        health: {
                            current: maxHealth,
                            max: maxHealth
                        },
                        experience: 0,
                        level: 1,
                        grade: "Grade 4",
                        money: startingMoney, // Starting money minus tool cost
                        history: [],
                        cooldowns: {}
                    },
                    portrait: profileImageUrl
                };
                
                // Set up different resources based on character type
                if (characterType === 'Sorcerer') {
                    // Cursed energy for sorcerers
                    const maxCursedEnergy = 80 + (wisdom * 10); // Base energy + bonus from wisdom
                    character.gameProgress.cursedEnergy = {
                        current: maxCursedEnergy,
                        max: maxCursedEnergy
                    };
                } else {
                    // Stamina for heavenly restriction characters
                    const maxStamina = 100 + (constitution * 5); // Base stamina + bonus from constitution
                    character.gameProgress.stamina = {
                        current: maxStamina,
                        max: maxStamina
                    };
                }
                
                // Add tool to inventory if selected
                if (toolName && toolName !== 'none') {
                    const toolDesc = formData.get('cursedToolDescription');
                    
                    const toolItem = {
                        id: 'tool_' + Date.now(),
                        name: toolName,
                        description: toolDesc,
                        type: 'tool',
                        equipped: true,
                        bonuses: toolBonuses
                    };
                    
                    character.gameProgress.inventory.push(toolItem);
                }
                
                state.currentCharacter = character;
                
                // If logged in, save to user's characters
                if (state.isLoggedIn && state.user) {
                    saveCharacterToUser(character);
                }
                
                return character;
            }
            
            function saveCharacterToUser(character) {
                if (!state.isLoggedIn || !state.user) return;
                
                const users = JSON.parse(localStorage.getItem('jjkDndUsers') || '[]');
                const userIndex = users.findIndex(u => u.username === state.user.username);
                
                if (userIndex === -1) return;
                
                let userCharacters = users[userIndex].characters || [];
                
                // Check if we're updating an existing character
                const existingCharIndex = userCharacters.findIndex(c => c.id === character.id);
                
                if (existingCharIndex !== -1) {
                    // Update existing character
                    userCharacters[existingCharIndex] = character;
                } else {
                    // Add new character (limit to 3)
                    if (userCharacters.length >= 3) {
                        showToast('Character Limit Reached', 'You can only save up to 3 characters. Please delete one to save a new one.', 'warning');
                        return false;
                    }
                    
                    userCharacters.push(character);
                }
                
                users[userIndex].characters = userCharacters;
                localStorage.setItem('jjkDndUsers', JSON.stringify(users));
                
                // Update local state
                state.savedCharacters = userCharacters;
                
                showToast('Character Saved', `${character.name} has been saved to your account!`);
                return true;
            }
            
            // Update character overview
            function updateCharacterOverview() {
                if (!state.currentCharacter) return;
                
                // Basic info
                document.getElementById('overview-name').textContent = state.currentCharacter.name;
                document.getElementById('overview-background').textContent = state.currentCharacter.background;
                document.getElementById('overview-gender').textContent = state.currentCharacter.gender;
                document.getElementById('overview-grade').textContent = 'Grade 4 Sorcerer';
                
                // Change title and display based on character type
                if (state.currentCharacter.characterType === 'Sorcerer') {
                    document.getElementById('overview-abilities-title').textContent = 'CURSED TECHNIQUES';
                    document.getElementById('overview-technique-type').textContent = state.currentCharacter.techniqueType + ' Technique';
                    document.getElementById('overview-technique-label').textContent = 'Primary Technique';
                    document.getElementById('overview-abilities-info').textContent = 'As you progress, you\'ll be able to learn additional techniques. These will become available as you gain experience and complete special quests.';
                    
                    // Show technique cost
                    const costValue = state.currentCharacter.cursedTechniqueCost || 20;
                    document.getElementById('overview-technique-cost').classList.remove('hidden');
                    document.getElementById('overview-cost-value').textContent = costValue;
                    
                    // Resource label
                    document.getElementById('overview-resource-label').textContent = 'Cursed Energy';
                    document.getElementById('overview-resource-bar').classList.remove('bg-orange-500');
                    document.getElementById('overview-resource-bar').classList.add('bg-blue-500');
                    
                    // Show energy container, hide stamina container
                    document.getElementById('overview-energy-container').classList.remove('hidden');
                    document.getElementById('overview-stamina-container').classList.add('hidden');
                } else {
                    document.getElementById('overview-abilities-title').textContent = 'HEAVENLY RESTRICTION';
                    document.getElementById('overview-technique-type').textContent = 'Heavenly Restriction';
                    document.getElementById('overview-technique-label').textContent = 'Physical Abilities';
                    document.getElementById('overview-abilities-info').textContent = 'Without cursed energy, you rely on your superhuman physical abilities. As you progress, you can further enhance these capabilities through training and special equipment.';
                    
                    // Hide technique cost
                    document.getElementById('overview-technique-cost').classList.add('hidden');
                    
                    // Resource label
                    document.getElementById('overview-resource-label').textContent = 'Stamina';
                    document.getElementById('overview-resource-bar').classList.remove('bg-blue-500');
                    document.getElementById('overview-resource-bar').classList.add('bg-orange-500');
                    
                    // Show stamina container, hide energy container
                    document.getElementById('overview-energy-container').classList.remove('hidden');
                    document.getElementById('overview-stamina-container').classList.add('hidden');
                }
                
                // Health and resources
                const maxHealth = state.currentCharacter.gameProgress.health.max;
                document.getElementById('overview-health').textContent = `${maxHealth}/${maxHealth}`;
                
                if (state.currentCharacter.characterType === 'Sorcerer') {
                    const maxEnergy = state.currentCharacter.gameProgress.cursedEnergy.max;
                    document.getElementById('overview-energy').textContent = `${maxEnergy}/${maxEnergy}`;
                } else {
                    const maxStamina = state.currentCharacter.gameProgress.stamina.max;
                    document.getElementById('overview-energy').textContent = `${maxStamina}/${maxStamina}`;
                }
                
                // Money - show with tool price deducted
                document.getElementById('overview-money').textContent = `${state.currentCharacter.gameProgress.money} ¥`;
                
                // Stats
                document.getElementById('overview-str').textContent = state.currentCharacter.stats.strength;
                document.getElementById('overview-dex').textContent = state.currentCharacter.stats.dexterity;
                document.getElementById('overview-con').textContent = state.currentCharacter.stats.constitution;
                document.getElementById('overview-int').textContent = state.currentCharacter.stats.intelligence;
                document.getElementById('overview-wis').textContent = state.currentCharacter.stats.wisdom;
                document.getElementById('overview-cha').textContent = state.currentCharacter.stats.charisma;
                
                // Technique
                document.getElementById('overview-technique').textContent = state.currentCharacter.cursedTechnique;
                
                // Tool
                const toolName = state.currentCharacter.cursedTool;
                const toolDesc = state.currentCharacter.cursedToolDescription;
                const toolBonuses = state.currentCharacter.cursedToolBonuses;
                const toolPrice = toolName && toolName !== 'none' && toolName !== 'random' ? toolPrices[toolName] || 0 : 0;
                
                if (toolName && toolName !== 'none') {
                    document.getElementById('overview-tool-name').textContent = toolName;
                    document.getElementById('overview-tool-desc').textContent = toolDesc;
                    
                    // Show bonuses if available
                    const toolBonusesElement = document.getElementById('overview-tool-bonuses');
                    if (toolBonuses) {
                        toolBonusesElement.textContent = formatStatBonuses(toolBonuses);
                        toolBonusesElement.classList.remove('hidden');
                    } else {
                        toolBonusesElement.classList.add('hidden');
                    }
                    
                    // Show price
                    const toolPriceElement = document.getElementById('overview-tool-price');
                    if (toolPrice > 0) {
                        toolPriceElement.textContent = `Price: ${toolPrice} ¥`;
                        toolPriceElement.classList.remove('hidden');
                    } else {
                        toolPriceElement.classList.add('hidden');
                    }
                } else {
                    document.getElementById('overview-tool-name').textContent = 'No Cursed Tool';
                    document.getElementById('overview-tool-desc').textContent = 'No cursed tool selected';
                    document.getElementById('overview-tool-bonuses').classList.add('hidden');
                    document.getElementById('overview-tool-price').classList.add('hidden');
                }
                
                // Update portrait if available
                const overviewPortrait = document.getElementById('overview-portrait');
                if (state.currentCharacter.portrait) {
                    overviewPortrait.innerHTML = `<img src="${state.currentCharacter.portrait}" class="w-full h-full object-cover" alt="${state.currentCharacter.name}">`;
                }
            }
            
            // Update character display in game
            function updateCharacterDisplay(character) {
                if (!character) return;
                
                // Basic info
                document.getElementById('char-name').textContent = character.name;
                document.getElementById('char-background').textContent = character.background;
                document.getElementById('char-technique').textContent = character.cursedTechnique;
                document.getElementById('mini-char-name').textContent = character.name;
                
                // Grade and level
                document.getElementById('sorcerer-grade').textContent = character.gameProgress.grade;
                document.getElementById('mini-grade').textContent = character.gameProgress.grade;
                document.getElementById('char-level').textContent = character.gameProgress.level;
                
                // Money
                document.getElementById('char-money').textContent = `${character.gameProgress.money || 500} ¥`;
                document.getElementById('mini-money').textContent = character.gameProgress.money || 500;
                
                // Stats
                document.getElementById('char-str').textContent = character.stats.strength;
                document.getElementById('char-dex').textContent = character.stats.dexterity;
                document.getElementById('char-con').textContent = character.stats.constitution;
                document.getElementById('char-int').textContent = character.stats.intelligence;
                document.getElementById('char-wis').textContent = character.stats.wisdom;
                document.getElementById('char-cha').textContent = character.stats.charisma;
                
                // Character type specific displays
                if (character.characterType === 'Sorcerer') {
                    // Show technique section, hide physical abilities
                    document.getElementById('technique-list').classList.remove('hidden');
                    document.getElementById('physical-abilities').classList.add('hidden');
                    document.getElementById('abilities-title').textContent = 'Cursed Techniques';
                    
                    // Update technique info
                    const techniqueId = character.cursedTechnique.split(' - ')[0];
                    document.getElementById('primary-technique-name').textContent = techniqueId;
                    document.getElementById('primary-technique-cost').textContent = character.cursedTechniqueCost || 20;
                    
                } else {
                    // Show physical abilities, hide technique section
                    document.getElementById('technique-list').classList.add('hidden');
                    document.getElementById('physical-abilities').classList.remove('hidden');
                    document.getElementById('abilities-title').textContent = 'Physical Abilities';
                }
                
                // Update resources
                updateResourceBars();
                
                // Update XP bar
                const xpBar = document.getElementById('xp-bar');
                const xpValue = document.getElementById('xp-value');
                const currentLevel = character.gameProgress.level;
                const currentXP = character.gameProgress.experience;
                
                // Calculate XP progress to next level
                const currentLevelXP = xpRequirements[currentLevel - 1];
                const nextLevelXP = currentLevel < 20 ? xpRequirements[currentLevel] : currentLevelXP;
                const xpProgress = ((currentXP - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;
                
                xpBar.style.width = `${currentLevel >= 20 ? 100 : xpProgress}%`;
                xpValue.textContent = `${currentXP}/${nextLevelXP}`;
                
                // Update portrait if available
                const charPortrait = document.getElementById('char-portrait');
                if (character.portrait) {
                    charPortrait.innerHTML = `<img src="${character.portrait}" class="w-full h-full object-cover" alt="${character.name}">`;
                }
                
                // Load cooldowns from character data
                if (character.gameProgress.cooldowns) {
                    state.cooldowns = character.gameProgress.cooldowns;
                    processCooldowns();
                }
            }
            
            // Roll dice function
            function rollDice(sides = 20) {
                const result = Math.floor(Math.random() * sides) + 1;
                const diceResult = document.getElementById('diceResult');
                diceResult.classList.remove('hidden');
                diceResult.querySelector('span').textContent = result;
                
                let resultText;
                if (sides === 20) {
                    if (result === 20) {
                        resultText = "Critical Success!";
                        diceResult.querySelector('span').classList.add('text-green-500');
                        diceResult.querySelector('span').classList.remove('text-red-500', 'text-jjk-purple', 'dark:text-primary-dark');
                    } else if (result === 1) {
                        resultText = "Critical Failure!";
                        diceResult.querySelector('span').classList.add('text-red-500');
                        diceResult.querySelector('span').classList.remove('text-green-500', 'text-jjk-purple', 'dark:text-primary-dark');
                    } else if (result >= 15) {
                        resultText = "Great Roll!";
                        diceResult.querySelector('span').classList.remove('text-red-500', 'text-green-500');
                        diceResult.querySelector('span').classList.add('text-jjk-purple', 'dark:text-primary-dark');
                    } else if (result <= 5) {
                        resultText = "Poor Roll!";
                        diceResult.querySelector('span').classList.remove('text-red-500', 'text-green-500');
                        diceResult.querySelector('span').classList.add('text-jjk-purple', 'dark:text-primary-dark');
                    } else {
                        resultText = "Standard Roll";
                        diceResult.querySelector('span').classList.remove('text-red-500', 'text-green-500');
                        diceResult.querySelector('span').classList.add('text-jjk-purple', 'dark:text-primary-dark');
                    }
                } else {
                    resultText = `D${sides} Roll`;
                    diceResult.querySelector('span').classList.remove('text-red-500', 'text-green-500');
                    diceResult.querySelector('span').classList.add('text-jjk-purple', 'dark:text-primary-dark');
                }
                
                diceResult.querySelector('p').textContent = resultText;
                
                addGameMessage('dice', `Rolled a D${sides} and got ${result} - ${resultText}`);
                
                return result;
            }
            
            // Add game message to the UI
            function addGameMessage(type, content, sender = null, saveToHistory = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                if (type === 'player') {
                    messageDiv.innerHTML = `
                        <div class="flex items-start mb-4">
                            <div class="flex-shrink-0 bg-primary/10 rounded-full w-10 h-10 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <div class="ml-3 bg-primary/5 dark:bg-primary-dark/10 rounded-lg py-2 px-4 max-w-[85%]">
                                <p class="text-gray-800 dark:text-gray-200 text-sm">${content}</p>
                            </div>
                        </div>
                    `;
                    
                    // Add to conversation history for context
                    if (saveToHistory) {
                        state.conversationHistory.push({
                            role: "user",
                            content: content
                        });
                        
                        // Keep only the last 2 messages (to support the 'memory' feature)
                        if (state.conversationHistory.length > 2) {
                            state.conversationHistory = state.conversationHistory.slice(-2);
                        }
                        
                        // Save to user account if logged in
                        if (state.isLoggedIn && state.user) {
                            saveConversationHistory();
                        }
                    }
                    
                } else if (type === 'gm') {
                    // For GM responses, use marked.js to render markdown
                    const formattedContent = marked.parse(content);
                    
                    messageDiv.innerHTML = `
                        <div class="flex items-start mb-4">
                            <div class="flex-shrink-0 bg-jjk-purple/10 rounded-full w-10 h-10 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-jjk-purple dark:text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                </svg>
                            </div>
                            <div class="ml-3 bg-white dark:bg-gray-800 rounded-lg py-3 px-4 shadow-sm border border-gray-100 dark:border-gray-700 max-w-[85%]">
                                <div class="message-content text-gray-800 dark:text-gray-200 text-sm">${formattedContent}</div>
                            </div>
                        </div>
                    `;
                    
                    // Add to conversation history for context
                    if (saveToHistory) {
                        state.conversationHistory.push({
                            role: "assistant",
                            content: content
                        });
                        
                        // Keep only the last 2 messages
                        if (state.conversationHistory.length > 2) {
                            state.conversationHistory = state.conversationHistory.slice(-2);
                        }
                        
                        // Save to user account if logged in
                        if (state.isLoggedIn && state.user) {
                            saveConversationHistory();
                        }
                    }
                    
                } else if (type === 'system') {
                    messageDiv.innerHTML = `
                        <div class="flex justify-center my-4">
                            <div class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 text-xs rounded-full px-3 py-1">
                                ${content}
                            </div>
                        </div>
                    `;
                } else if (type === 'dice') {
                    messageDiv.innerHTML = `
                        <div class="flex justify-center my-4">
                            <div class="bg-jjk-purple/10 text-jjk-purple dark:text-primary-dark text-sm rounded-lg px-4 py-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                    <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                                    <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                                    <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                </svg>
                                ${content}
                            </div>
                        </div>
                    `;
                } else if (type === 'resource') {
                    messageDiv.innerHTML = `
                        <div class="flex justify-center my-4">
                            <div class="bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-sm rounded-lg px-4 py-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                                </svg>
                                ${content}
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('gameMessages').appendChild(messageDiv);
                
                // Scroll to bottom
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
                
                // Save to history if relevant and if saveToHistory flag is true
                if (saveToHistory && type !== 'system' && state.currentCharacter) {
                    // Initialize history array if it doesn't exist
                    if (!state.currentCharacter.gameProgress.history) {
                        state.currentCharacter.gameProgress.history = [];
                    }
                    
                    state.currentCharacter.gameProgress.history.push({
                        type,
                        content,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Auto-save if user is logged in
                    if (state.isLoggedIn && state.user) {
                        // Use a debounced version to avoid too many saves
                        if (window.autoSaveTimeout) {
                            clearTimeout(window.autoSaveTimeout);
                        }
                        window.autoSaveTimeout = setTimeout(() => {
                            try {
                                saveCharacterToUser(state.currentCharacter);
                                console.log("Auto-saved game progress");
                            } catch (err) {
                                console.error("Error auto-saving game progress:", err);
                            }
                        }, 3000); // Wait 3 seconds after last message before saving
                    }
                }
            }
            
            // Add typing indicator (for loading effect)
            function addTypingIndicator() {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'typingIndicator';
                loadingDiv.className = 'flex items-start mb-4';
                loadingDiv.innerHTML = `
                    <div class="flex-shrink-0 bg-jjk-purple/10 rounded-full w-10 h-10 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-jjk-purple dark:text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                    </div>
                    <div class="ml-3 bg-white dark:bg-gray-800 rounded-lg py-3 px-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-800 dark:text-gray-200 text-sm typing-indicator">Thinking</div>
                    </div>
                `;
                
                document.getElementById('gameMessages').appendChild(loadingDiv);
                loadingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
                
                return loadingDiv;
            }
            
            // Remove typing indicator
            function removeTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            // Submit player action to AI
            async function submitActionToAI(action) {
                try {
                    // Create context for the action including character info
                    const character = state.currentCharacter;
                    
                    let systemMessage = `The player is ${character.name}, a ${character.gender} ${character.background} `;
                    
                    if (character.characterType === 'Sorcerer') {
                        systemMessage += `with the ${character.cursedTechnique.split(' - ')[0]} technique. `;
                    } else {
                        systemMessage += `with Heavenly Restriction (superhuman physical abilities but no cursed energy). `;
                    }
                    
                    systemMessage += `They are currently a ${character.gameProgress.grade} sorcerer at level ${character.gameProgress.level}. `;
                    
                    if (character.cursedTool && character.cursedTool !== 'none') {
                        systemMessage += `They wield a ${character.cursedTool} as their cursed tool. `;
                    }
                    
                    // Stats info
                    systemMessage += `Their stats are: STR ${character.stats.strength}, DEX ${character.stats.dexterity}, CON ${character.stats.constitution}, INT ${character.stats.intelligence}, WIS ${character.stats.wisdom}, CHA ${character.stats.charisma}. `;
                    
                    // Include conversation context if available
                    if (state.conversationHistory.length > 0) {
                        systemMessage += "\n\nPrevious conversation context:\n";
                        state.conversationHistory.forEach(msg => {
                            if (msg.role === "user") {
                                systemMessage += `Player: ${msg.content}\n`;
                            } else {
                                systemMessage += `Game Master: ${msg.content}\n`;
                            }
                        });
                    }
                    
                    systemMessage += `\nThe player just performed this action: "${action}"\n\nRespond as the Game Master, continuing the adventure in the style of Jujutsu Kaisen. Be creative, descriptive, and engaging while maintaining the tone and style of the series.`;
                    
                    // Check if Poe API is available
                    if (window.Poe) {
                        // Show loading indicator
                        addTypingIndicator();                        try {
                            const botResponse = await window.Poe.sendUserMessage(
                                "@Claude-3.7-Sonnet " + systemMessage,
                                {
                                    stream: true,
                                    handler: "gameActionHandler",
                                    openChat: false
                                }
                            );
                            
                            console.log("Action response initiated:", botResponse);
                        } catch (error) {
                            console.error("Error sending action to AI:", error);
                            removeTypingIndicator();
                            addGameMessage('system', 'Error getting response from the Game Master. Please try again.');
                            state.isAwaitingResponse = false;
                        }
                    } else {
                        // Fallback for testing or if Poe API isn't available
                        console.log("Poe API not detected, using fallback response");
                        
                        // Show typing indicator
                        addTypingIndicator();
                        
                        setTimeout(() => {
                            removeTypingIndicator();
                            
                            // Generate a simple response based on the action
                            let response = '';
                            
                            if (action.toLowerCase().includes('technique') || action.toLowerCase().includes('cursed energy')) {
                                if (character.characterType === 'Sorcerer') {
                                    response = `As you channel your cursed energy into your ${character.cursedTechnique.split(' - ')[0]} technique, you feel the power surge through your body. The air around you shimmers with the manifestation of your cursed energy.

"Impressive control," Gojo comments, observing your technique with interest. "But remember, efficient use of cursed energy is just as important as raw power. Each technique has a cost - you need to manage your reserves carefully in battle."

You notice that using your technique has depleted some of your cursed energy, but it's gradually beginning to replenish. With more practice, you'll become more efficient with your energy usage.

What would you like to do next?`;
                                } else {
                                    response = `You attempt to channel cursed energy, but nothing happens. As a person with Heavenly Restriction, you cannot manipulate cursed energy like normal sorcerers.

However, Gojo nods approvingly. "Your Heavenly Restriction grants you superhuman physical abilities in exchange for cursed energy. While others rely on techniques, your strength, speed, and durability far exceed theirs. But remember - even with your enhanced stamina, physical exertion will still tire you eventually."

You can feel your muscles ready for action, but you know sustained effort will deplete your stamina over time.

What would you like to do instead?`;
                                }
                            } else if (action.toLowerCase().includes('strength') || action.toLowerCase().includes('physical')) {
                                if (character.characterType === 'HeavenlyRestriction') {
                                    response = `You tap into your superhuman physical abilities, feeling the raw power that comes with your Heavenly Restriction. Your muscles surge with strength that would be impossible for a normal human or even most sorcerers.

Gojo watches with interest. "That's the advantage of Heavenly Restriction. The trade-off for lacking cursed energy gives you physical capabilities that can overwhelm many curse users. But don't forget - even with your enhanced endurance, you'll still get tired eventually."

You notice that the exertion has drained some of your stamina, though it's already beginning to recover. Managing your energy will be crucial in extended battles.

What would you like to do next?`;
                                } else {
                                    response = `You focus on a physical approach rather than using your cursed technique. While not as powerful as someone with Heavenly Restriction, your physical training as a jujutsu sorcerer still makes you formidable.

"Smart," Gojo comments. "Not every situation calls for cursed techniques. Sometimes conserving your cursed energy and using physical attacks is the better strategy."

Your physical exertion has tired you slightly, but you've preserved your cursed energy reserves, which could be valuable if you encounter stronger opponents later.

What will you do now?`;
                                }
                            } else if (action.toLowerCase().includes('rest') || action.toLowerCase().includes('recover')) {
                                response = `You take a moment to catch your breath and center yourself. As you focus on your breathing, you can feel your energy slowly returning.

"Good instinct," Gojo says with approval. "Knowing when to rest and recover is just as important as knowing when to fight. Even the strongest sorcerers need to manage their resources carefully."

The brief respite has allowed you to recover some of your ${character.characterType === 'Sorcerer' ? 'cursed energy' : 'stamina'} and clear your mind. You feel more prepared for whatever comes next.

What would you like to do now?`;
                            } else {
                                response = `You ${action.toLowerCase()}.

Gojo observes your actions with interest. "Every choice reveals something about a sorcerer's style and thinking," he comments. "The way you approach problems will define your path as a jujutsu sorcerer."

You notice that your actions have used some of your ${character.characterType === 'Sorcerer' ? 'cursed energy' : 'stamina'}, but it's gradually replenishing. Managing your resources efficiently will be crucial for your survival in the world of jujutsu.

What would you like to do next?`;
                            }
                            
                            // Add GM response
                            addGameMessage('gm', response);
                            
                            // Reset awaiting flag
                            state.isAwaitingResponse = false;
                        }, 1500);
                    }
                } catch (error) {
                    console.error("Error in submitActionToAI:", error);
                    removeTypingIndicator();
                    addGameMessage('system', 'Error processing your action. Please try again.');
                    state.isAwaitingResponse = false;
                }
            }
            
            // Start Game with AI integration
            async function startGame(character) {
                console.log("Starting game with character:", character);
                
                // Update character display
                updateCharacterDisplay(character);
                
                // Clear game messages UI (but not history!)
                document.getElementById('gameMessages').innerHTML = '';
                
                // Show loading indicator
                const loadingIndicator = addTypingIndicator();
                
                // Add welcome message
                addGameMessage('system', 'Your adventure begins...');
                
                // Add resource management message based on character type
                if (character.characterType === 'Sorcerer') {
                    addGameMessage('resource', 'You are a Jujutsu Sorcerer who uses Cursed Energy. Using your technique will consume energy, which recovers slowly over time.');
                } else {
                    addGameMessage('resource', 'With Heavenly Restriction, you have superhuman physical abilities but no cursed energy. Physical feats will consume stamina, which recovers gradually over time.');
                }
                
                try {
                    // Create context for initial message
                    let systemMessage = `You are the Game Master for a Jujutsu Kaisen D&D adventure. The player is ${character.name}, a ${character.gender} ${character.background} `;
                    
                    if (character.characterType === 'Sorcerer') {
                        systemMessage += `with the ${character.cursedTechnique.split(' - ')[0]} technique. `;
                    } else {
                        systemMessage += `with Heavenly Restriction (superhuman physical abilities but no cursed energy). `;
                    }
                    
                    systemMessage += `They are a Grade 4 sorcerer just starting their journey.`;
                    
                    if (character.cursedTool && character.cursedTool !== 'none') {
                        systemMessage += ` They wield a ${character.cursedTool} as their cursed tool.`;
                    }
                    
                    // Stats info
                    systemMessage += ` Their stats are: STR ${character.stats.strength}, DEX ${character.stats.dexterity}, CON ${character.stats.constitution}, INT ${character.stats.intelligence}, WIS ${character.stats.wisdom}, CHA ${character.stats.charisma}.`;
                    
                    // Initialize the game scenario with resource management context
                    if (character.characterType === 'Sorcerer') {
                        systemMessage += ` As a sorcerer, they use cursed energy to power their techniques. Using techniques costs energy which recovers slowly over time. More powerful applications cost more energy.`;
                    } else {
                        systemMessage += ` With Heavenly Restriction, they have superhuman physical abilities but no cursed energy. Physical feats cost stamina which recovers gradually. Even with enhanced capabilities, they can't fight indefinitely.`;
                    }
                    
                    systemMessage += ` Begin by having them meet Satoru Gojo at Tokyo Jujutsu High School for their initial evaluation. Be creative, descriptive, and engaging. Maintain the tone and style of Jujutsu Kaisen.`;
                    
                    // Add previous conversation context if available
                    let conversationContext = "";
                    if (state.conversationHistory.length > 0) {
                        conversationContext = "\n\nPrevious conversation:\n";
                        state.conversationHistory.forEach(msg => {
                            if (msg.role === "user") {
                                conversationContext += `Player: ${msg.content}\n`;
                            } else {
                                conversationContext += `Game Master: ${msg.content}\n`;
                            }
                        });
                        systemMessage += conversationContext;
                    }
                    
                    console.log("Sending initial prompt to Claude...");
                    
                    // Check if Poe API is available
                    if (window.Poe) {
                        const botResponse = await window.Poe.sendUserMessage(
                            "@Claude-3.7-Sonnet " + systemMessage,
                            {
                                stream: true,
                                handler: "gameStartHandler",
                                openChat: false
                            }
                        );
                        
                        console.log("Response initiated:", botResponse);
                    } else {
                        // Fallback for testing or if Poe API isn't available
                        console.log("Poe API not detected, using fallback response");
                        setTimeout(() => {
                            removeTypingIndicator();
                            
                            let resourceMention = '';
                            if (character.characterType === 'Sorcerer') {
                                resourceMention = `\n\nAs you channel a small amount of cursed energy to demonstrate your control, you feel the subtle drain on your reserves. You'll need to manage your energy carefully in battle - different techniques require different amounts of cursed energy, and once depleted, you'll need time to recover.`;
                            } else {
                                resourceMention = `\n\nEven without cursed energy, your body feels incredibly powerful - a benefit of your Heavenly Restriction. But you're aware that even with your superhuman stamina, extended physical exertion will eventually tire you out. You'll need to manage your stamina wisely in prolonged encounters.`;
                            }
                            
                            addGameMessage('gm', `Welcome, ${character.name}, to the world of Jujutsu Kaisen!

As a ${character.background} with ${character.characterType === 'Sorcerer' ? `the ${character.cursedTechnique.split(' - ')[0]} technique` : 'Heavenly Restriction'}, you're about to embark on a dangerous journey into the world of curses and sorcery.

You find yourself standing at the entrance of Tokyo Jujutsu High School, the prestigious academy for training jujutsu sorcerers. The imposing building seems to shimmer with cursed energy, invisible to ordinary humans but clear as day to you.

A tall figure approaches - Satoru Gojo, the most powerful jujutsu sorcerer alive. His blindfold conceals his legendary Six Eyes, but his aura of casual confidence is unmistakable.

"So you're the new student I've heard about," he says with a slight smirk. "Interesting ${character.characterType === 'Sorcerer' ? 'technique' : 'condition'} you've got there. Let's see if you've got what it takes to become a true sorcerer."${resourceMention}

What do you do?`);
                        }, 1500);
                    }
                } catch (error) {
                    console.error("Error starting game with AI:", error);
                    removeTypingIndicator();
                    addGameMessage('system', 'Error connecting to the Game Master. Please try again later.');
                }
            }
            
            // Set up handler for start game AI response
            if (window.Poe) {
                window.Poe.registerHandler("gameStartHandler", (result, context) => {
                    // Remove loading indicator when we get any response
                    removeTypingIndicator();
                    
                    if (result.status === "error") {
                        console.error("Error from Claude:", result);
                        addGameMessage('system', 'Error getting response from the Game Master. Please try again.');
                        return;
                    }
                    
                    if (result.responses && result.responses.length > 0) {
                        const response = result.responses[0];
                        
                        if (result.status === "complete") {
                            // Final message
                            addGameMessage('gm', response.content);
                            state.isAwaitingResponse = false;
                        } else if (result.status === "incomplete") {
                            // This is a streaming update
                            if (!document.getElementById('ai-response-container')) {
                                // Create container for streaming response
                                const responseContainer = document.createElement('div');
                                responseContainer.id = 'ai-response-container';
                                
                                // Add the container but don't save to history yet
                                addGameMessage('gm', response.content, null, false);
                                
                                // Mark that we're waiting for the complete response
                                state.isAwaitingResponse = true;
                            } else {
                                // Remove the previous container and add updated one
                                const oldContainer = document.getElementById('ai-response-container');
                                if (oldContainer) oldContainer.remove();
                                
                                // Add updated content but don't save to history yet
                                addGameMessage('gm', response.content, null, false);
                            }
                        }
                    }
                });
                
                window.Poe.registerHandler("gameActionHandler", (result, context) => {
                    // Remove loading indicator when we get any response
                    removeTypingIndicator();
                    
                    if (result.status === "error") {
                        console.error("Error from Claude:", result);
                        addGameMessage('system', 'Error getting response from the Game Master. Please try again.');
                        return;
                    }
                    
                    if (result.responses && result.responses.length > 0) {
                        const response = result.responses[0];
                        
                        if (result.status === "complete") {
                            // Final message
                            addGameMessage('gm', response.content);
                            state.isAwaitingResponse = false;
                        } else if (result.status === "incomplete") {
                            // This is a streaming update
                            if (!document.getElementById('ai-response-container')) {
                                // Create container for streaming response
                                const responseContainer = document.createElement('div');
                                responseContainer.id = 'ai-response-container';
                                
                                // Add the container but don't save to history yet
                                addGameMessage('gm', response.content, null, false);
                                
                                // Mark that we're waiting for the complete response
                                state.isAwaitingResponse = true;
                            } else {
                                // Remove the previous container and add updated one
                                const oldContainer = document.getElementById('ai-response-container');
                                if (oldContainer) oldContainer.remove();
                                
                                // Add updated content but don't save to history yet
                                addGameMessage('gm', response.content, null, false);
                            }
                        }
                    }
                });
            }
            
            // Handle player action submission with AI integration
            async function submitPlayerAction() {
                const action = document.getElementById('userAction').value.trim();
                if (!action || state.isAwaitingResponse) return;
                
                // Clear the input
                document.getElementById('userAction').value = '';
                
                // Add player message to the game
                addGameMessage('player', action);
                
                // Mark that we're waiting for AI response
                state.isAwaitingResponse = true;
                
                // Submit to AI
                await submitActionToAI(action);
            }
            
            // Buy item function
            function buyItem(itemData) {
                if (!state.currentCharacter) {
                    showToast('No Character', 'You need to have an active character', 'error');
                    return;
                }
                
                const { itemId, itemName, itemPrice, itemDesc, itemType, itemBonuses, itemCost } = itemData;
                const price = parseInt(itemPrice);
                
                // Check if player has enough money
                if (state.currentCharacter.gameProgress.money < price) {
                    showToast('Not Enough Money', `You need ${price} ¥ to buy this item`, 'error');
                    return;
                }
                
                // Create the item
                const newItem = {
                    id: itemId + '_' + Date.now(),
                    name: itemName,
                    description: itemDesc,
                    type: itemType,
                    price: price,
                    equipped: false
                };
                
                // Add technique cost if applicable
                if (itemType === 'technique' && itemCost) {
                    newItem.cost = parseInt(itemCost);
                }
                
                // Add healing/energy/stamina values if applicable
                if (itemData.healing) newItem.healing = parseInt(itemData.healing);
                if (itemData.energy) newItem.energy = parseInt(itemData.energy);
                if (itemData.stamina) newItem.stamina = parseInt(itemData.stamina);
                
                // Add bonuses if available
                if (itemBonuses) {
                    try {
                        newItem.bonuses = JSON.parse(itemBonuses);
                    } catch (e) {
                        console.error("Error parsing item bonuses:", e);
                    }
                }
                
                // Add to inventory
                if (!state.currentCharacter.gameProgress.inventory) {
                    state.currentCharacter.gameProgress.inventory = [];
                }
                
                state.currentCharacter.gameProgress.inventory.push(newItem);
                
                // Deduct money
                state.currentCharacter.gameProgress.money -= price;
                
                // Save character
                if (state.isLoggedIn && state.user) {
                    saveCharacterToUser(state.currentCharacter);
                }
                
                // Update UI
                updateShopDisplay();
                
                // Show success message
                showToast('Item Purchased', `You bought ${itemName} for ${price} ¥`, 'success');
            }
            
            // Copy share link to clipboard
            function copyShareLink() {
                const shareUrl = window.location.href;
                
                // Use clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        showToast('Link Copied', 'You can now share this app with friends!', 'success');
                    }).catch(() => {
                        showToast('Copy Failed', 'Could not copy link. Please try again.', 'error');
                    });
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        showToast('Link Copied', 'You can now share this app with friends!', 'success');
                    } catch (err) {
                        showToast('Copy Failed', 'Could not copy link. Please try again.', 'error');
                    }
                    
                    document.body.removeChild(textArea);
                }
            }
            
            // Stats adjustments
            document.querySelectorAll('.stat-btn-decrease').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = btn.nextElementSibling;
                    const stat = input.id.replace('Stat', '');
                    const currentValue = state.stats[stat.toLowerCase()];
                    
                    if (currentValue > 1) {
                        state.stats[stat.toLowerCase()] = currentValue - 1;
                        state.pointsUsed -= 1;
                        state.pointsRemaining = state.pointsTotal - state.pointsUsed;
                        updateStatsDisplay();
                    }
                });
            });
            
            document.querySelectorAll('.stat-btn-increase').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = btn.previousElementSibling;
                    const stat = input.id.replace('Stat', '');
                    const currentValue = state.stats[stat.toLowerCase()];
                    
                    if (currentValue < 10 && state.pointsRemaining > 0) {
                        state.stats[stat.toLowerCase()] = currentValue + 1;
                        state.pointsUsed += 1;
                        state.pointsRemaining = state.pointsTotal - state.pointsUsed;
                        updateStatsDisplay();
                    }
                });
            });
            
            function updateStatsDisplay() {
                document.getElementById('pointsRemaining').querySelector('span').textContent = state.pointsRemaining;
                
                // Update stat inputs
                document.getElementById('strengthStat').value = state.stats.strength;
                document.getElementById('dexterityStat').value = state.stats.dexterity;
                document.getElementById('constitutionStat').value = state.stats.constitution;
                document.getElementById('intelligenceStat').value = state.stats.intelligence;
                document.getElementById('wisdomStat').value = state.stats.wisdom;
                document.getElementById('charismaStat').value = state.stats.charisma;
                
                // Toggle button states
                document.querySelectorAll('.stat-btn-decrease').forEach(btn => {
                    const input = btn.nextElementSibling;
                    const stat = input.id.replace('Stat', '');
                    const statValue = state.stats[stat.toLowerCase()];
                    
                    btn.disabled = statValue <= 1;
                    btn.classList.toggle('opacity-50', statValue <= 1);
                    btn.classList.toggle('cursor-not-allowed', statValue <= 1);
                });
                
                document.querySelectorAll('.stat-btn-increase').forEach(btn => {
                    const input = btn.previousElementSibling;
                    const stat = input.id.replace('Stat', '');
                    const statValue = state.stats[stat.toLowerCase()];
                    
                    btn.disabled = statValue >= 10 || state.pointsRemaining <= 0;
                    btn.classList.toggle('opacity-50', statValue >= 10 || state.pointsRemaining <= 0);
                    btn.classList.toggle('cursor-not-allowed', statValue >= 10 || state.pointsRemaining <= 0);
                });
            }
            
            // Handle character type toggle
            const characterTypeRadios = document.querySelectorAll('input[name="characterType"]');
            const techniqueSection = document.getElementById('techniqueSection');
            const heavenlyRestrictionSection = document.getElementById('heavenlyRestrictionSection');
            
            characterTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'Sorcerer') {
                        techniqueSection.classList.remove('hidden');
                        heavenlyRestrictionSection.classList.add('hidden');
                        
                        // Reset stats if Heavenly Restriction was previously selected
                        if (state.stats.strength >= 30) {
                            state.stats.strength -= 30;
                            state.pointsUsed -= 30;
                        }
                        if (state.stats.dexterity >= 30) {
                            state.stats.dexterity -= 30;
                            state.pointsUsed -= 30;
                        }
                        if (state.stats.constitution >= 30) {
                            state.stats.constitution -= 30;
                            state.pointsUsed -= 30;
                        }
                        state.pointsRemaining = state.pointsTotal - state.pointsUsed;
                        updateStatsDisplay();
                    } else if (this.value === 'HeavenlyRestriction') {
                        techniqueSection.classList.add('hidden');
                        heavenlyRestrictionSection.classList.remove('hidden');
                        
                        // Apply x30 superhuman bonuses to stats
                        state.stats.strength += 30;
                        state.stats.dexterity += 30;
                        state.stats.constitution += 30;
                        state.pointsUsed += 90;
                        state.pointsRemaining = state.pointsTotal - state.pointsUsed;
                        updateStatsDisplay();
                        
                        // Display a notice about the superhuman abilities
                        showToast('Heavenly Restriction', 'You\'ve chosen Heavenly Restriction, granting you x30 superhuman physical abilities like Toji Fushiguro or Maki Zenin!', 'info', 5000);
                    }
                });
            });
            
            // Technique selector functionality
            const techniqueSelect = document.getElementById('techniqueSelect');
            const randomTechniqueContainer = document.getElementById('randomTechniqueContainer');
            const techniqueDescription = document.getElementById('techniqueDescription');
            const rollTechniqueBtn = document.getElementById('rollTechniqueBtn');
            const randomTechniqueResult = document.getElementById('randomTechniqueResult');
            const randomTechniqueText = document.getElementById('randomTechniqueText');
            const techniqueDescriptionText = document.getElementById('techniqueDescriptionText');
            const techniqueCost = document.getElementById('techniqueCost');
            const techniqueEnergyCost = document.getElementById('techniqueEnergyCost');
            
            techniqueSelect.addEventListener('change', function() {
                if (this.value === 'random') {
                    randomTechniqueContainer.classList.remove('hidden');
                    techniqueDescription.classList.add('hidden');
                } else if (this.value !== '') {
                    randomTechniqueContainer.classList.add('hidden');
                    randomTechniqueResult.classList.add('hidden');
                    
                    // Check if we have a detailed description for this technique
                    if (techniqueDescriptions[this.value]) {
                        techniqueDescription.classList.remove('hidden');
                        techniqueDescriptionText.textContent = techniqueDescriptions[this.value];
                        document.getElementById('cursedTechnique').value = this.value + " - " + techniqueDescriptions[this.value];
                        
                        // Show energy cost
                        const cost = techniqueCosts[this.value] || 20;
                        techniqueCost.classList.remove('hidden');
                        techniqueEnergyCost.textContent = cost;
                        document.getElementById('cursedTechniqueCost').value = cost;
                    } else {
                        techniqueDescription.classList.add('hidden');
                        document.getElementById('cursedTechnique').value = this.value + " - A powerful cursed technique";
                        document.getElementById('cursedTechniqueCost').value = 20; // Default cost
                    }
                } else {
                    randomTechniqueContainer.classList.add('hidden');
                    randomTechniqueResult.classList.add('hidden');
                    techniqueDescription.classList.add('hidden');
                    document.getElementById('cursedTechnique').value = '';
                    document.getElementById('cursedTechniqueCost').value = '0';
                }
            });
            
            rollTechniqueBtn.addEventListener('click', () => {
                // Roll for a random technique
                const randomIndex = Math.floor(Math.random() * randomTechniques.length);
                const rolledTechnique = randomTechniques[randomIndex];
                
                // Show the result
                randomTechniqueResult.classList.remove('hidden');
                randomTechniqueText.textContent = rolledTechnique;
                document.getElementById('cursedTechnique').value = rolledTechnique;
                document.getElementById('cursedTechniqueCost').value = techniqueCosts.random || 20;
                
                // Visual feedback
                randomTechniqueResult.classList.add('animate-pulse');
                setTimeout(() => {
                    randomTechniqueResult.classList.remove('animate-pulse');
                }, 1000);
            });
            
            // Cursed Tool selector functionality
            const cursedToolSelect = document.getElementById('cursedToolSelect');
            const randomToolContainer = document.getElementById('randomToolContainer');
            const toolDescription = document.getElementById('toolDescription');
            const rollToolBtn = document.getElementById('rollToolBtn');
            const randomToolResult = document.getElementById('randomToolResult');
            const randomToolText = document.getElementById('randomToolText');
            const toolDescriptionText = document.getElementById('toolDescriptionText');
            const toolPriceWarning = document.getElementById('toolPriceWarning');
            const toolPrice = document.getElementById('toolPrice');
            const toolBonuses = document.getElementById('toolBonuses');
            
            cursedToolSelect.addEventListener('change', function() {
                if (this.value === 'random') {
                    randomToolContainer.classList.remove('hidden');
                    toolDescription.classList.add('hidden');
                    toolPriceWarning.classList.add('hidden');
                } else if (this.value === 'none') {
                    randomToolContainer.classList.add('hidden');
                    randomToolResult.classList.add('hidden');
                    toolDescription.classList.add('hidden');
                    toolPriceWarning.classList.add('hidden');
                    document.getElementById('cursedToolDescription').value = "None";
                    document.getElementById('cursedToolPrice').value = "0";
                } else if (this.value !== '') {
                    randomToolContainer.classList.add('hidden');
                    randomToolResult.classList.add('hidden');
                    
                    // Show price warning
                    const price = toolPrices[this.value] || 0;
                    if (price > 0) {
                        toolPriceWarning.classList.remove('hidden');
                        document.getElementById('cursedToolPrice').value = price;
                    } else {
                        toolPriceWarning.classList.add('hidden');
                    }
                    
                    // Check if we have a detailed description for this tool
                    if (toolDescriptions[this.value]) {
                        toolDescription.classList.remove('hidden');
                        toolDescriptionText.textContent = toolDescriptions[this.value];
                        document.getElementById('cursedToolDescription').value = toolDescriptions[this.value];
                        
                        // Show price in the description
                        if (price > 0) {
                            toolPrice.textContent = `Price: ${price} ¥`;
                            toolPrice.classList.remove('hidden');
                        } else {
                            toolPrice.classList.add('hidden');
                        }
                        
                        // Show bonuses if available
                        if (toolStatBonuses[this.value]) {
                            toolBonuses.classList.remove('hidden');
                            toolBonuses.textContent = `Bonuses: ${formatStatBonuses(toolStatBonuses[this.value])}`;
                        } else {
                            toolBonuses.classList.add('hidden');
                        }
                    } else {
                        toolDescription.classList.add('hidden');
                        document.getElementById('cursedToolDescription').value = '';
                    }
                } else {
                    randomToolContainer.classList.add('hidden');
                    randomToolResult.classList.add('hidden');
                    toolDescription.classList.add('hidden');
                    toolPriceWarning.classList.add('hidden');
                    document.getElementById('cursedToolDescription').value = '';
                    document.getElementById('cursedToolPrice').value = "0";
                }
            });
            
            rollToolBtn.addEventListener('click', () => {
                // Roll for a random tool
                const randomIndex = Math.floor(Math.random() * randomTools.length);
                const rolledTool = randomTools[randomIndex];
                
                // Show the result
                randomToolResult.classList.remove('hidden');
                randomToolText.textContent = rolledTool;
                document.getElementById('cursedToolDescription').value = rolledTool;
                
                // Extract tool name for price
                const toolName = rolledTool.split(' - ')[0];
                const price = toolPrices[toolName] || 0;
                document.getElementById('cursedToolPrice').value = price;
                
                // Show price warning
                if (price > 0) {
                    toolPriceWarning.classList.remove('hidden');
                } else {
                    toolPriceWarning.classList.add('hidden');
                }
                
                // Visual feedback
                randomToolResult.classList.add('animate-pulse');
                setTimeout(() => {
                    randomToolResult.classList.remove('animate-pulse');
                }, 1000);
            });
            
            // Profile picture upload
            const profilePictureInput = document.getElementById('profilePictureInput');
            const profilePicturePreview = document.getElementById('profilePicturePreview');
            
            profilePictureInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Clear any existing content
                        profilePicturePreview.innerHTML = '';
                        
                        // Create image element
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-full h-full object-cover';
                        profilePicturePreview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Shop tabs functionality
            document.querySelectorAll('.shop-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all tabs
                    document.querySelectorAll('.shop-tab-btn').forEach(tabBtn => {
                        tabBtn.classList.remove('text-primary', 'dark:text-primary-dark', 'border-primary', 'dark:border-primary-dark');
                        tabBtn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'dark:hover:text-gray-300', 'border-transparent');
                    });
                    
                    // Add active class to clicked tab
                    btn.classList.add('text-primary', 'dark:text-primary-dark', 'border-primary', 'dark:border-primary-dark');
                    btn.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'dark:hover:text-gray-300', 'border-transparent');
                    
                    // Hide all tab contents
                    document.querySelectorAll('.shop-tab').forEach(tab => {
                        tab.classList.add('hidden');
                    });
                    
                    // Show selected tab content
                    const tabId = btn.id.replace('tab', '') + 'Tab';
                    document.getElementById(tabId).classList.remove('hidden');
                });
            });
            
            // Navigation buttons
            document.getElementById('createCharacterBtn').addEventListener('click', () => {
                showScreen('characterCreationScreen');
            });
            
            document.getElementById('loadCharacterBtn').addEventListener('click', () => {
                if (state.isLoggedIn) {
                    // Show load character screen (not implemented in this simplified version)
                    showToast('Loading Characters', 'This feature is coming soon', 'info');
                } else {
                    showToast('Login Required', 'Please login to load characters', 'warning');
                    showAuthModal('login');
                }
            });
            
            document.getElementById('backToStartBtn').addEventListener('click', () => {
                showScreen('startScreen');
            });
            
            document.getElementById('backToCreationBtn').addEventListener('click', () => {
                showScreen('characterCreationScreen');
            });
            
            document.getElementById('backToGameBtn').addEventListener('click', () => {
                showScreen('gameScreen');
            });
            
            // Copy link button
            document.getElementById('copyLinkBtn').addEventListener('click', copyShareLink);
            
            document.getElementById('startAdventureBtn').addEventListener('click', () => {
                console.log("Start Adventure button clicked");
                showScreen('gameScreen');
                startGame(state.currentCharacter);
            });
            
            document.getElementById('exitGameBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to exit the game? Unsaved progress will be lost.')) {
                    // Stop resource regeneration
                    if (state.resourceRegenInterval) {
                        clearInterval(state.resourceRegenInterval);
                        state.resourceRegenInterval = null;
                    }
                    
                    showScreen('startScreen');
                }
            });
            
            document.getElementById('showCharSheetBtn').addEventListener('click', () => {
                showCharacterSheet();
            });
            
            document.getElementById('closeCharSheetBtn').addEventListener('click', () => {
                hideCharacterSheet();
            });
            
            document.getElementById('openShopBtn').addEventListener('click', () => {
                showScreen('shopScreen');
            });
            
            // Resource confirmation modal handlers
            document.getElementById('cancelResourceBtn').addEventListener('click', () => {
                hideResourceConfirmation();
            });
            
            document.getElementById('confirmResourceBtn').addEventListener('click', () => {
                // Execute the pending action
                if (state.pendingAction && typeof state.pendingAction.execute === 'function') {
                    state.pendingAction.execute();
                }
                
                // Hide the modal
                hideResourceConfirmation();
            });
            
            // Technique/ability buttons
            document.getElementById('use-technique-btn').addEventListener('click', () => {
                // Only for sorcerers
                if (!state.currentCharacter || state.currentCharacter.characterType !== 'Sorcerer') return;
                
                // Get technique name from character
                const techniqueId = state.currentCharacter.cursedTechnique.split(' - ')[0];
                useTechnique(techniqueId);
            });
            
            // Physical ability buttons (for heavenly restriction)
            document.getElementById('use-strength-btn').addEventListener('click', () => {
                usePhysicalAbility('Superhuman Strength');
            });
            
            document.getElementById('use-speed-btn').addEventListener('click', () => {
                usePhysicalAbility('Enhanced Speed');
            });
            
            // Rest and recover button
            document.getElementById('restBtn').addEventListener('click', () => {
                // Check for cooldown
                if (state.cooldowns && state.cooldowns['rest']) {
                    const timeLeft = Math.ceil((state.cooldowns['rest'].endsAt - Date.now()) / 1000);
                    showToast('Rest on Cooldown', `You need to wait ${timeLeft} seconds before resting again.`, 'warning');
                    return;
                }
                
                restAndRecover();
            });
            
            // Auth event listeners
            document.getElementById('loginBtn').addEventListener('click', () => {
                showAuthModal('login');
            });
            
            document.getElementById('signupBtn').addEventListener('click', () => {
                showAuthModal('signup');
            });
            
            document.getElementById('loginTabBtn').addEventListener('click', () => {
                document.getElementById('loginTabBtn').classList.add('bg-primary', 'text-white');
                document.getElementById('signupTabBtn').classList.remove('bg-primary', 'text-white');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('signupForm').classList.add('hidden');
            });
            
            document.getElementById('signupTabBtn').addEventListener('click', () => {
                document.getElementById('signupTabBtn').classList.add('bg-primary', 'text-white');
                document.getElementById('loginTabBtn').classList.remove('bg-primary', 'text-white');
                document.getElementById('signupForm').classList.remove('hidden');
                document.getElementById('loginForm').classList.add('hidden');
            });
            
            document.getElementById('closeAuthBtn').addEventListener('click', hideAuthModal);
            
            document.getElementById('submitLoginBtn').addEventListener('click', () => {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!username || !password) {
                    showToast('Login Error', 'Please enter both username and password', 'error');
                    return;
                }
                
                login(username, password);
            });
            
            document.getElementById('submitSignupBtn').addEventListener('click', () => {
                const username = document.getElementById('signupUsername').value;
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!username || !password || !confirmPassword) {
                    showToast('Signup Error', 'Please fill in all fields', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showToast('Signup Error', 'Passwords do not match', 'error');
                    return;
                }
                
                signup(username, password);
            });
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Character creation form submission
            document.getElementById('characterForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const formData = new FormData(this);
                
                // Validate form data
                if (!formData.get('charName') || !formData.get('charGender') || !formData.get('charBackground')) {
                    showToast('Missing Information', 'Please fill out all required fields', 'error');
                    return;
                }
                
                // If sorcerer but no technique selected
                if (formData.get('characterType') === 'Sorcerer' && !formData.get('cursedTechnique')) {
                    showToast('Missing Technique', 'Please select a cursed technique', 'error');
                    return;
                }
                
                // Create character
                const character = createCharacter(formData);
                
                // Show character overview
                showScreen('characterOverviewScreen');
            });
            
            // Shop item purchase
            document.querySelectorAll('.buy-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const itemData = {
                        itemId: btn.dataset.itemId,
                        itemName: btn.dataset.itemName,
                        itemPrice: btn.dataset.itemPrice,
                        itemDesc: btn.dataset.itemDesc,
                        itemType: btn.dataset.itemType,
                        itemBonuses: btn.dataset.itemBonuses,
                        itemCost: btn.dataset.itemCost,
                        healing: btn.dataset.healing,
                        energy: btn.dataset.energy,
                        stamina: btn.dataset.stamina
                    };
                    
                    buyItem(itemData);
                });
            });
            
            // Game controls
            document.getElementById('submitActionBtn').addEventListener('click', submitPlayerAction);
            
            document.getElementById('userAction').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitPlayerAction();
                }
            });
            
            document.getElementById('actionsMenuBtn').addEventListener('click', () => {
                document.getElementById('actionsDropdown').classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!document.getElementById('actionsMenuBtn')?.contains(e.target) && 
                    !document.getElementById('actionsDropdown')?.contains(e.target)) {
                    document.getElementById('actionsDropdown')?.classList.add('hidden');
                }
            });
            
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    let actionText = '';
                    
                    switch (action) {
                        case 'attack':
                            actionText = 'I attack the enemy with ';
                            break;
                        case 'investigate':
                            actionText = 'I investigate ';
                            break;
                        case 'use-technique':
                            actionText = 'I use my cursed technique to ';
                            break;
                        case 'talk':
                            actionText = 'I talk to ';
                            break;
                        case 'use-item':
                            actionText = 'I use my ';
                            break;
                        case 'run':
                            actionText = 'I try to escape from ';
                            break;
                    }
                    
                    document.getElementById('userAction').value = actionText;
                    document.getElementById('userAction').focus();
                    document.getElementById('actionsDropdown').classList.add('hidden');
                    
                    // Place cursor at the end of the text
                    const userAction = document.getElementById('userAction');
                    const length = userAction.value.length;
                    userAction.setSelectionRange(length, length);
                });
            });
            
            document.getElementById('rollDiceBtn').addEventListener('click', () => {
                rollDice(20);
            });
            
            document.getElementById('saveGameBtn').addEventListener('click', () => {
                if (state.isLoggedIn && state.currentCharacter) {
                    saveCharacterToUser(state.currentCharacter);
                } else {
                    showToast('Login Required', 'Please login to save your game progress', 'warning');
                    showAuthModal('login');
                }
            });
            
            document.getElementById('toggleCharPanelBtn').addEventListener('click', () => {
                const charPanel = document.getElementById('charPanel');
                if (charPanel.classList.contains('hidden')) {
                    charPanel.classList.remove('hidden');
                } else {
                    charPanel.classList.add('hidden');
                }
            });
            
            // Initialize stats display
            updateStatsDisplay();

            // Add EXTRA Console Logs for Debugging the Start Adventure Button
            console.log("Checking startAdventureBtn element");
            const startAdventureBtn = document.getElementById('startAdventureBtn');
            if (startAdventureBtn) {
                console.log("Found startAdventureBtn:", startAdventureBtn);
                
                // IMPORTANT: Remove any existing event listeners before adding a new one
                startAdventureBtn.replaceWith(startAdventureBtn.cloneNode(true));
                
                // Get the new button reference after replacement
                const newStartAdventureBtn = document.getElementById('startAdventureBtn');
                
                newStartAdventureBtn.addEventListener('click', function(e) {
                    console.log("Start Adventure button clicked! Event:", e);
                    
                    if (!state.currentCharacter) {
                        console.error("No character found in state!");
                        showToast('No Character', 'No character created or loaded', 'error');
                        return;
                    }
                    
                    console.log("Showing game screen...");
                    showScreen('gameScreen');
                    
                    console.log("Starting game with character:", state.currentCharacter);
                    startGame(state.currentCharacter);
                });
                
                console.log("New event listener added to startAdventureBtn");
            } else {
                console.error("Start Adventure button not found!");
            }
        });
    </script>
</body>
</html>
